From 42f20ce3666605690dac88b7532304c277a50034 Mon Sep 17 00:00:00 2001
From: serafim <serafimcloud@gmail.com>
Date: Fri, 16 Jan 2026 13:59:16 -0800
Subject: [PATCH] Release v0.0.14

---
 package.json                                  |   2 +-
 src/main/lib/trpc/routers/agent-utils.ts      | 244 ++++++++
 src/main/lib/trpc/routers/agents.ts           | 275 +++++++++
 src/main/lib/trpc/routers/claude.ts           | 167 ++++-
 src/main/lib/trpc/routers/index.ts            |   2 +
 .../dialogs/agents-settings-dialog.tsx        |  18 +-
 .../dialogs/settings-tabs/agent-dialog.tsx    | 368 +++++++++++
 .../agents-custom-agents-tab.tsx              | 282 +++++++++
 .../settings-tabs/agents-skills-tab.tsx       |  19 +-
 .../components/dialogs/settings-tabs/index.ts |   1 +
 .../dialogs/settings-tabs/tool-selector.tsx   | 159 +++++
 src/renderer/features/agents/atoms/index.ts   |   4 +
 .../features/agents/lib/ipc-chat-transport.ts |  57 +-
 .../features/agents/main/active-chat.tsx      | 131 +++-
 .../agents/mentions/agents-file-mention.tsx   | 577 ++++++++----------
 .../mentions/agents-mentions-editor.tsx       |   8 +-
 .../agents/mentions/render-file-mentions.tsx  |  45 +-
 .../ui/agent-ask-user-question-tool.tsx       |  62 +-
 .../agents/ui/agent-user-question.tsx         |   1 +
 .../agents/ui/sub-chat-context-menu.tsx       |  16 +-
 .../features/agents/ui/sub-chat-selector.tsx  |  23 +-
 .../sidebar/agents-subchats-sidebar.tsx       |  34 +-
 .../sub-chats/sub-chat-context-menu.tsx       |  16 +-
 .../features/sub-chats/sub-chats-sidebar.tsx  |  15 +-
 src/renderer/lib/atoms/index.ts               |   5 +-
 25 files changed, 2086 insertions(+), 445 deletions(-)
 create mode 100644 src/main/lib/trpc/routers/agent-utils.ts
 create mode 100644 src/main/lib/trpc/routers/agents.ts
 create mode 100644 src/renderer/components/dialogs/settings-tabs/agent-dialog.tsx
 create mode 100644 src/renderer/components/dialogs/settings-tabs/agents-custom-agents-tab.tsx
 create mode 100644 src/renderer/components/dialogs/settings-tabs/tool-selector.tsx

diff --git a/package.json b/package.json
index cec6ef3..f3ecc3b 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "21st-desktop",
-  "version": "0.0.13",
+  "version": "0.0.14",
   "private": true,
   "description": "1Code - UI for parallel work with AI agents",
   "author": "21st.dev",
diff --git a/src/main/lib/trpc/routers/agent-utils.ts b/src/main/lib/trpc/routers/agent-utils.ts
new file mode 100644
index 0000000..fab52f4
--- /dev/null
+++ b/src/main/lib/trpc/routers/agent-utils.ts
@@ -0,0 +1,244 @@
+import * as fs from "fs/promises"
+import * as path from "path"
+import * as os from "os"
+import matter from "gray-matter"
+
+// Valid model values for agents
+export const VALID_AGENT_MODELS = ["sonnet", "opus", "haiku", "inherit"] as const
+export type AgentModel = (typeof VALID_AGENT_MODELS)[number]
+
+// Agent definition parsed from markdown file
+export interface ParsedAgent {
+  name: string
+  description: string
+  prompt: string
+  tools?: string[]
+  disallowedTools?: string[]
+  model?: AgentModel
+}
+
+// Agent with source/path metadata
+export interface FileAgent extends ParsedAgent {
+  source: "user" | "project"
+  path: string
+}
+
+/**
+ * Parse agent markdown file with YAML frontmatter
+ * Format:
+ * ---
+ * name: code-reviewer
+ * description: Reviews code for quality
+ * tools: Read, Glob, Grep
+ * model: sonnet
+ * ---
+ *
+ * You are a code reviewer. When invoked...
+ */
+export function parseAgentMd(
+  content: string,
+  filename: string
+): Partial<ParsedAgent> {
+  try {
+    const { data, content: body } = matter(content)
+
+    // Parse tools - can be comma-separated string or array
+    let tools: string[] | undefined
+    if (typeof data.tools === "string") {
+      tools = data.tools
+        .split(",")
+        .map((t: string) => t.trim())
+        .filter(Boolean)
+    } else if (Array.isArray(data.tools)) {
+      tools = data.tools
+    }
+
+    // Parse disallowedTools
+    let disallowedTools: string[] | undefined
+    if (typeof data.disallowedTools === "string") {
+      disallowedTools = data.disallowedTools
+        .split(",")
+        .map((t: string) => t.trim())
+        .filter(Boolean)
+    } else if (Array.isArray(data.disallowedTools)) {
+      disallowedTools = data.disallowedTools
+    }
+
+    // Validate model
+    const model =
+      data.model && VALID_AGENT_MODELS.includes(data.model)
+        ? (data.model as AgentModel)
+        : undefined
+
+    return {
+      name:
+        typeof data.name === "string" ? data.name : filename.replace(".md", ""),
+      description: typeof data.description === "string" ? data.description : "",
+      prompt: body.trim(),
+      tools,
+      disallowedTools,
+      model,
+    }
+  } catch (err) {
+    console.error("[agents] Failed to parse markdown:", err)
+    return {}
+  }
+}
+
+/**
+ * Generate markdown content for agent file
+ */
+export function generateAgentMd(agent: {
+  name: string
+  description: string
+  prompt: string
+  tools?: string[]
+  disallowedTools?: string[]
+  model?: AgentModel
+}): string {
+  const frontmatter: string[] = []
+  frontmatter.push(`name: ${agent.name}`)
+  frontmatter.push(`description: ${agent.description}`)
+  if (agent.tools && agent.tools.length > 0) {
+    frontmatter.push(`tools: ${agent.tools.join(", ")}`)
+  }
+  if (agent.disallowedTools && agent.disallowedTools.length > 0) {
+    frontmatter.push(`disallowedTools: ${agent.disallowedTools.join(", ")}`)
+  }
+  if (agent.model && agent.model !== "inherit") {
+    frontmatter.push(`model: ${agent.model}`)
+  }
+
+  return `---\n${frontmatter.join("\n")}\n---\n\n${agent.prompt}`
+}
+
+/**
+ * Load agent definition from filesystem by name
+ * Searches in user (~/.claude/agents/) and project (.claude/agents/) directories
+ */
+export async function loadAgent(
+  name: string,
+  cwd?: string
+): Promise<ParsedAgent | null> {
+  const locations = [
+    path.join(os.homedir(), ".claude", "agents"),
+    ...(cwd ? [path.join(cwd, ".claude", "agents")] : []),
+  ]
+
+  for (const dir of locations) {
+    const agentPath = path.join(dir, `${name}.md`)
+    try {
+      const content = await fs.readFile(agentPath, "utf-8")
+      const parsed = parseAgentMd(content, `${name}.md`)
+
+      if (parsed.description && parsed.prompt) {
+        return {
+          name: parsed.name || name,
+          description: parsed.description,
+          prompt: parsed.prompt,
+          tools: parsed.tools,
+          disallowedTools: parsed.disallowedTools,
+          model: parsed.model,
+        }
+      }
+    } catch {
+      continue
+    }
+  }
+
+  return null
+}
+
+/**
+ * Scan directory for agent .md files
+ * Format: .claude/agents/agent-name.md
+ */
+export async function scanAgentsDirectory(
+  dir: string,
+  source: "user" | "project"
+): Promise<FileAgent[]> {
+  const agents: FileAgent[] = []
+
+  try {
+    await fs.access(dir)
+    const entries = await fs.readdir(dir, { withFileTypes: true })
+
+    for (const entry of entries) {
+      // Validate entry name for security (prevent path traversal)
+      if (
+        entry.name.includes("..") ||
+        entry.name.includes("/") ||
+        entry.name.includes("\\")
+      ) {
+        console.warn(`[agents] Skipping invalid filename: ${entry.name}`)
+        continue
+      }
+
+      // Accept .md files (Claude Code native format)
+      if (entry.isFile() && entry.name.endsWith(".md")) {
+        const agentPath = path.join(dir, entry.name)
+        try {
+          const content = await fs.readFile(agentPath, "utf-8")
+          const parsed = parseAgentMd(content, entry.name)
+
+          if (parsed.description && parsed.prompt) {
+            agents.push({
+              name: parsed.name || entry.name.replace(".md", ""),
+              description: parsed.description,
+              prompt: parsed.prompt,
+              tools: parsed.tools,
+              disallowedTools: parsed.disallowedTools,
+              model: parsed.model,
+              source,
+              path: agentPath,
+            })
+          }
+        } catch (err) {
+          console.error(`[agents] Failed to read agent ${entry.name}:`, err)
+        }
+      }
+    }
+  } catch (err) {
+    // Directory doesn't exist or not accessible
+    if ((err as NodeJS.ErrnoException).code !== "ENOENT") {
+      console.warn(`[agents] Could not scan directory ${dir}:`, err)
+    }
+  }
+
+  return agents
+}
+
+/**
+ * Build agents Record for SDK Options
+ * This properly registers agents with the SDK so Claude can invoke them via Task tool
+ */
+export async function buildAgentsOption(
+  agentNames: string[],
+  cwd?: string
+): Promise<
+  Record<
+    string,
+    { description: string; prompt: string; tools?: string[]; model?: AgentModel }
+  >
+> {
+  if (agentNames.length === 0) return {}
+
+  const agents: Record<
+    string,
+    { description: string; prompt: string; tools?: string[]; model?: AgentModel }
+  > = {}
+
+  for (const name of agentNames) {
+    const agent = await loadAgent(name, cwd)
+    if (agent) {
+      agents[name] = {
+        description: agent.description,
+        prompt: agent.prompt,
+        ...(agent.tools && { tools: agent.tools }),
+        ...(agent.model && { model: agent.model }),
+      }
+    }
+  }
+
+  return agents
+}
diff --git a/src/main/lib/trpc/routers/agents.ts b/src/main/lib/trpc/routers/agents.ts
new file mode 100644
index 0000000..423061d
--- /dev/null
+++ b/src/main/lib/trpc/routers/agents.ts
@@ -0,0 +1,275 @@
+import { z } from "zod"
+import { router, publicProcedure } from "../index"
+import * as fs from "fs/promises"
+import * as path from "path"
+import * as os from "os"
+import {
+  parseAgentMd,
+  generateAgentMd,
+  scanAgentsDirectory,
+  VALID_AGENT_MODELS,
+  type FileAgent,
+} from "./agent-utils"
+
+// Shared procedure for listing agents
+const listAgentsProcedure = publicProcedure
+  .input(
+    z
+      .object({
+        cwd: z.string().optional(),
+      })
+      .optional(),
+  )
+  .query(async ({ input }) => {
+    const userAgentsDir = path.join(os.homedir(), ".claude", "agents")
+    const userAgentsPromise = scanAgentsDirectory(userAgentsDir, "user")
+
+    let projectAgentsPromise = Promise.resolve<FileAgent[]>([])
+    if (input?.cwd) {
+      const projectAgentsDir = path.join(input.cwd, ".claude", "agents")
+      projectAgentsPromise = scanAgentsDirectory(projectAgentsDir, "project")
+    }
+
+    const [userAgents, projectAgents] = await Promise.all([
+      userAgentsPromise,
+      projectAgentsPromise,
+    ])
+
+    return [...projectAgents, ...userAgents]
+  })
+
+export const agentsRouter = router({
+  /**
+   * List all agents from filesystem
+   * - User agents: ~/.claude/agents/
+   * - Project agents: .claude/agents/ (relative to cwd)
+   */
+  list: listAgentsProcedure,
+
+  /**
+   * Alias for list - used by @ mention
+   */
+  listEnabled: listAgentsProcedure,
+
+  /**
+   * Get single agent by name
+   */
+  get: publicProcedure
+    .input(z.object({ name: z.string(), cwd: z.string().optional() }))
+    .query(async ({ input }) => {
+      const locations = [
+        {
+          dir: path.join(os.homedir(), ".claude", "agents"),
+          source: "user" as const,
+        },
+        ...(input.cwd
+          ? [
+              {
+                dir: path.join(input.cwd, ".claude", "agents"),
+                source: "project" as const,
+              },
+            ]
+          : []),
+      ]
+
+      for (const { dir, source } of locations) {
+        const agentPath = path.join(dir, `${input.name}.md`)
+        try {
+          const content = await fs.readFile(agentPath, "utf-8")
+          const parsed = parseAgentMd(content, `${input.name}.md`)
+          return {
+            ...parsed,
+            source,
+            path: agentPath,
+          }
+        } catch {
+          continue
+        }
+      }
+      return null
+    }),
+
+  /**
+   * Create a new agent
+   */
+  create: publicProcedure
+    .input(
+      z.object({
+        name: z.string(),
+        description: z.string(),
+        prompt: z.string(),
+        tools: z.array(z.string()).optional(),
+        disallowedTools: z.array(z.string()).optional(),
+        model: z.enum(VALID_AGENT_MODELS).optional(),
+        source: z.enum(["user", "project"]),
+        cwd: z.string().optional(),
+      })
+    )
+    .mutation(async ({ input }) => {
+      // Validate name (kebab-case, no special chars)
+      const safeName = input.name.toLowerCase().replace(/[^a-z0-9-]/g, "-")
+      if (!safeName || safeName.includes("..")) {
+        throw new Error("Invalid agent name")
+      }
+
+      // Determine target directory
+      let targetDir: string
+      if (input.source === "project") {
+        if (!input.cwd) {
+          throw new Error("Project path (cwd) required for project agents")
+        }
+        targetDir = path.join(input.cwd, ".claude", "agents")
+      } else {
+        targetDir = path.join(os.homedir(), ".claude", "agents")
+      }
+
+      // Ensure directory exists
+      await fs.mkdir(targetDir, { recursive: true })
+
+      const agentPath = path.join(targetDir, `${safeName}.md`)
+
+      // Check if already exists
+      try {
+        await fs.access(agentPath)
+        throw new Error(`Agent "${safeName}" already exists`)
+      } catch (err) {
+        if ((err as NodeJS.ErrnoException).code !== "ENOENT") {
+          throw err
+        }
+      }
+
+      // Generate and write file
+      const content = generateAgentMd({
+        name: safeName,
+        description: input.description,
+        prompt: input.prompt,
+        tools: input.tools,
+        disallowedTools: input.disallowedTools,
+        model: input.model,
+      })
+
+      await fs.writeFile(agentPath, content, "utf-8")
+
+      return {
+        name: safeName,
+        path: agentPath,
+        source: input.source,
+      }
+    }),
+
+  /**
+   * Update an existing agent
+   */
+  update: publicProcedure
+    .input(
+      z.object({
+        originalName: z.string(),
+        name: z.string(),
+        description: z.string(),
+        prompt: z.string(),
+        tools: z.array(z.string()).optional(),
+        disallowedTools: z.array(z.string()).optional(),
+        model: z.enum(VALID_AGENT_MODELS).optional(),
+        source: z.enum(["user", "project"]),
+        cwd: z.string().optional(),
+      })
+    )
+    .mutation(async ({ input }) => {
+      // Validate names
+      const safeOriginalName = input.originalName.toLowerCase().replace(/[^a-z0-9-]/g, "-")
+      const safeName = input.name.toLowerCase().replace(/[^a-z0-9-]/g, "-")
+      if (!safeOriginalName || !safeName || safeName.includes("..")) {
+        throw new Error("Invalid agent name")
+      }
+
+      // Determine target directory
+      let targetDir: string
+      if (input.source === "project") {
+        if (!input.cwd) {
+          throw new Error("Project path (cwd) required for project agents")
+        }
+        targetDir = path.join(input.cwd, ".claude", "agents")
+      } else {
+        targetDir = path.join(os.homedir(), ".claude", "agents")
+      }
+
+      const originalPath = path.join(targetDir, `${safeOriginalName}.md`)
+      const newPath = path.join(targetDir, `${safeName}.md`)
+
+      // Check original exists
+      try {
+        await fs.access(originalPath)
+      } catch {
+        throw new Error(`Agent "${safeOriginalName}" not found`)
+      }
+
+      // If renaming, check new name doesn't exist
+      if (safeOriginalName !== safeName) {
+        try {
+          await fs.access(newPath)
+          throw new Error(`Agent "${safeName}" already exists`)
+        } catch (err) {
+          if ((err as NodeJS.ErrnoException).code !== "ENOENT") {
+            throw err
+          }
+        }
+      }
+
+      // Generate and write file
+      const content = generateAgentMd({
+        name: safeName,
+        description: input.description,
+        prompt: input.prompt,
+        tools: input.tools,
+        disallowedTools: input.disallowedTools,
+        model: input.model,
+      })
+
+      // Delete old file if renaming
+      if (safeOriginalName !== safeName) {
+        await fs.unlink(originalPath)
+      }
+
+      await fs.writeFile(newPath, content, "utf-8")
+
+      return {
+        name: safeName,
+        path: newPath,
+        source: input.source,
+      }
+    }),
+
+  /**
+   * Delete an agent
+   */
+  delete: publicProcedure
+    .input(
+      z.object({
+        name: z.string(),
+        source: z.enum(["user", "project"]),
+        cwd: z.string().optional(),
+      })
+    )
+    .mutation(async ({ input }) => {
+      const safeName = input.name.toLowerCase().replace(/[^a-z0-9-]/g, "-")
+      if (!safeName || safeName.includes("..")) {
+        throw new Error("Invalid agent name")
+      }
+
+      let targetDir: string
+      if (input.source === "project") {
+        if (!input.cwd) {
+          throw new Error("Project path (cwd) required for project agents")
+        }
+        targetDir = path.join(input.cwd, ".claude", "agents")
+      } else {
+        targetDir = path.join(os.homedir(), ".claude", "agents")
+      }
+
+      const agentPath = path.join(targetDir, `${safeName}.md`)
+
+      await fs.unlink(agentPath)
+
+      return { deleted: true }
+    }),
+})
diff --git a/src/main/lib/trpc/routers/claude.ts b/src/main/lib/trpc/routers/claude.ts
index 7f2472b..e2d2548 100644
--- a/src/main/lib/trpc/routers/claude.ts
+++ b/src/main/lib/trpc/routers/claude.ts
@@ -2,6 +2,8 @@ import { observable } from "@trpc/server/observable"
 import { eq } from "drizzle-orm"
 import { app, safeStorage } from "electron"
 import path from "path"
+import * as os from "os"
+import * as fs from "fs/promises"
 import { z } from "zod"
 import {
   buildClaudeEnv,
@@ -13,6 +15,55 @@ import {
 } from "../../claude"
 import { chats, claudeCodeCredentials, getDatabase, subChats } from "../../db"
 import { publicProcedure, router } from "../index"
+import { buildAgentsOption } from "./agent-utils"
+
+/**
+ * Parse @[agent:name] and @[skill:name] mentions from prompt text
+ * Returns the cleaned prompt and lists of mentioned agents/skills
+ */
+function parseMentions(prompt: string): {
+  cleanedPrompt: string
+  agentMentions: string[]
+  skillMentions: string[]
+  fileMentions: string[]
+  folderMentions: string[]
+} {
+  const agentMentions: string[] = []
+  const skillMentions: string[] = []
+  const fileMentions: string[] = []
+  const folderMentions: string[] = []
+
+  // Match @[prefix:name] pattern
+  const mentionRegex = /@\[(file|folder|skill|agent):([^\]]+)\]/g
+  let match
+
+  while ((match = mentionRegex.exec(prompt)) !== null) {
+    const [, type, name] = match
+    switch (type) {
+      case "agent":
+        agentMentions.push(name)
+        break
+      case "skill":
+        skillMentions.push(name)
+        break
+      case "file":
+        fileMentions.push(name)
+        break
+      case "folder":
+        folderMentions.push(name)
+        break
+    }
+  }
+
+  // Clean agent/skill mentions from prompt (they will be added as context)
+  // Keep file/folder mentions as they are useful context
+  const cleanedPrompt = prompt
+    .replace(/@\[agent:[^\]]+\]/g, "")
+    .replace(/@\[skill:[^\]]+\]/g, "")
+    .trim()
+
+  return { cleanedPrompt, agentMentions, skillMentions, fileMentions, folderMentions }
+}
 
 /**
  * Decrypt token using Electron's safeStorage
@@ -235,9 +286,42 @@ export const claudeRouter = router({
             // Capture stderr from Claude process for debugging
             const stderrLines: string[] = []
 
+            // Parse mentions from prompt (agents, skills, files, folders)
+            const { cleanedPrompt, agentMentions, skillMentions } = parseMentions(input.prompt)
+
+            // Build agents option for SDK (proper registration via options.agents)
+            const agentsOption = await buildAgentsOption(agentMentions, input.cwd)
+
+            // Log if agents were mentioned
+            if (agentMentions.length > 0) {
+              console.log(`[claude] Registering agents via SDK:`, Object.keys(agentsOption))
+            }
+
+            // Log if skills were mentioned
+            if (skillMentions.length > 0) {
+              console.log(`[claude] Skills mentioned:`, skillMentions)
+            }
+
+            // Build final prompt with skill instructions if needed
+            let finalPrompt = cleanedPrompt
+
+            // Handle empty prompt when only mentions are present
+            if (!finalPrompt.trim()) {
+              if (agentMentions.length > 0 && skillMentions.length > 0) {
+                finalPrompt = `Use the ${agentMentions.join(", ")} agent(s) and invoke the "${skillMentions.join('", "')}" skill(s) using the Skill tool for this task.`
+              } else if (agentMentions.length > 0) {
+                finalPrompt = `Use the ${agentMentions.join(", ")} agent(s) for this task.`
+              } else if (skillMentions.length > 0) {
+                finalPrompt = `Invoke the "${skillMentions.join('", "')}" skill(s) using the Skill tool for this task.`
+              }
+            } else if (skillMentions.length > 0) {
+              // Append skill instruction to existing prompt
+              finalPrompt = `${finalPrompt}\n\nUse the "${skillMentions.join('", "')}" skill(s) for this task.`
+            }
+
             // Build prompt: if there are images, create an AsyncIterable<SDKUserMessage>
             // Otherwise use simple string prompt
-            let prompt: string | AsyncIterable<any> = input.prompt
+            let prompt: string | AsyncIterable<any> = finalPrompt
 
             if (input.images && input.images.length > 0) {
               // Create message content array with images first, then text
@@ -253,10 +337,10 @@ export const claudeRouter = router({
               ]
 
               // Add text if present
-              if (input.prompt.trim()) {
+              if (finalPrompt.trim()) {
                 messageContent.push({
                   type: "text" as const,
-                  text: input.prompt,
+                  text: finalPrompt,
                 })
               }
 
@@ -295,6 +379,44 @@ export const claudeRouter = router({
               input.subChatId
             )
 
+            // Ensure isolated config dir exists and symlink skills/agents from ~/.claude/
+            // This is needed because SDK looks for skills at $CLAUDE_CONFIG_DIR/skills/
+            try {
+              await fs.mkdir(isolatedConfigDir, { recursive: true })
+
+              const homeClaudeDir = path.join(os.homedir(), ".claude")
+              const skillsSource = path.join(homeClaudeDir, "skills")
+              const skillsTarget = path.join(isolatedConfigDir, "skills")
+              const agentsSource = path.join(homeClaudeDir, "agents")
+              const agentsTarget = path.join(isolatedConfigDir, "agents")
+
+              // Symlink skills directory if source exists and target doesn't
+              try {
+                const skillsSourceExists = await fs.stat(skillsSource).then(() => true).catch(() => false)
+                const skillsTargetExists = await fs.lstat(skillsTarget).then(() => true).catch(() => false)
+                if (skillsSourceExists && !skillsTargetExists) {
+                  await fs.symlink(skillsSource, skillsTarget, "dir")
+                  console.log(`[claude] Symlinked skills: ${skillsTarget} -> ${skillsSource}`)
+                }
+              } catch (symlinkErr) {
+                // Ignore symlink errors (might already exist or permission issues)
+              }
+
+              // Symlink agents directory if source exists and target doesn't
+              try {
+                const agentsSourceExists = await fs.stat(agentsSource).then(() => true).catch(() => false)
+                const agentsTargetExists = await fs.lstat(agentsTarget).then(() => true).catch(() => false)
+                if (agentsSourceExists && !agentsTargetExists) {
+                  await fs.symlink(agentsSource, agentsTarget, "dir")
+                  console.log(`[claude] Symlinked agents: ${agentsTarget} -> ${agentsSource}`)
+                }
+              } catch (symlinkErr) {
+                // Ignore symlink errors (might already exist or permission issues)
+              }
+            } catch (mkdirErr) {
+              console.error(`[claude] Failed to setup isolated config dir:`, mkdirErr)
+            }
+
             // Build final env - only add OAuth token if we have one
             const finalEnv = {
               ...claudeEnv,
@@ -317,8 +439,9 @@ export const claudeRouter = router({
                 systemPrompt: {
                   type: "preset" as const,
                   preset: "claude_code" as const,
-                  append: " ",
                 },
+                // Register mentioned agents with SDK via options.agents
+                ...(Object.keys(agentsOption).length > 0 && { agents: agentsOption }),
                 env: finalEnv,
                 permissionMode:
                   input.mode === "plan"
@@ -370,12 +493,43 @@ export const claudeRouter = router({
                       })
                     })
 
+                    // Find the tool part in accumulated parts
+                    const askToolPart = parts.find(
+                      (p) => p.toolCallId === toolUseID && p.type === "tool-AskUserQuestion"
+                    )
+
                     if (!response.approved) {
+                      // Update the tool part with error result for skipped/denied
+                      const errorMessage = response.message || "Skipped"
+                      if (askToolPart) {
+                        askToolPart.result = errorMessage
+                        askToolPart.state = "result"
+                      }
+                      // Emit result to frontend so it updates in real-time
+                      safeEmit({
+                        type: "ask-user-question-result",
+                        toolUseId: toolUseID,
+                        result: errorMessage,
+                      } as UIMessageChunk)
                       return {
                         behavior: "deny",
-                        message: response.message || "Skipped",
+                        message: errorMessage,
                       }
                     }
+
+                    // Update the tool part with answers result for approved
+                    const answers = (response.updatedInput as any)?.answers
+                    const answerResult = { answers }
+                    if (askToolPart) {
+                      askToolPart.result = answerResult
+                      askToolPart.state = "result"
+                    }
+                    // Emit result to frontend so it updates in real-time
+                    safeEmit({
+                      type: "ask-user-question-result",
+                      toolUseId: toolUseID,
+                      result: answerResult,
+                    } as UIMessageChunk)
                     return {
                       behavior: "allow",
                       updatedInput: response.updatedInput,
@@ -545,9 +699,6 @@ export const claudeRouter = router({
                       })
                       break
                     case "tool-output-available":
-                      // DEBUG: Log all tool outputs
-                      console.log(`[SD] M:TOOL_OUTPUT sub=${subId} callId=${chunk.toolCallId} mode=${input.mode}`)
-
                       const toolPart = parts.find(
                         (p) =>
                           p.type?.startsWith("tool-") &&
diff --git a/src/main/lib/trpc/routers/index.ts b/src/main/lib/trpc/routers/index.ts
index 6e2e165..58ca627 100644
--- a/src/main/lib/trpc/routers/index.ts
+++ b/src/main/lib/trpc/routers/index.ts
@@ -8,6 +8,7 @@ import { externalRouter } from "./external"
 import { filesRouter } from "./files"
 import { debugRouter } from "./debug"
 import { skillsRouter } from "./skills"
+import { agentsRouter } from "./agents"
 import { createGitRouter } from "../../git"
 import { BrowserWindow } from "electron"
 
@@ -26,6 +27,7 @@ export function createAppRouter(getWindow: () => BrowserWindow | null) {
     files: filesRouter,
     debug: debugRouter,
     skills: skillsRouter,
+    agents: agentsRouter,
     // Git operations - named "changes" to match Superset API
     changes: createGitRouter(),
   })
diff --git a/src/renderer/components/dialogs/agents-settings-dialog.tsx b/src/renderer/components/dialogs/agents-settings-dialog.tsx
index 306f08b..7fae7a8 100644
--- a/src/renderer/components/dialogs/agents-settings-dialog.tsx
+++ b/src/renderer/components/dialogs/agents-settings-dialog.tsx
@@ -4,20 +4,19 @@ import { createPortal } from "react-dom"
 import { AnimatePresence, motion } from "motion/react"
 import { X, Bug, ChevronLeft, ChevronRight } from "lucide-react"
 import { cn } from "../../lib/utils"
-import { agentsSettingsDialogActiveTabAtom } from "../../lib/atoms"
+import { agentsSettingsDialogActiveTabAtom, type SettingsTab } from "../../lib/atoms"
 import {
   ProfileIconFilled,
   EyeOpenFilledIcon,
   SlidersFilledIcon,
 } from "../../icons"
-import { SkillIcon } from "../ui/icons"
+import { SkillIcon, AgentIcon } from "../ui/icons"
 import { AgentsAppearanceTab } from "./settings-tabs/agents-appearance-tab"
 import { AgentsProfileTab } from "./settings-tabs/agents-profile-tab"
 import { AgentsPreferencesTab } from "./settings-tabs/agents-preferences-tab"
 import { AgentsDebugTab } from "./settings-tabs/agents-debug-tab"
 import { AgentsSkillsTab } from "./settings-tabs/agents-skills-tab"
-
-type SettingsTab = "profile" | "appearance" | "preferences" | "skills" | "debug"
+import { AgentsCustomAgentsTab } from "./settings-tabs/agents-custom-agents-tab"
 
 // Hook to detect narrow screen
 function useIsNarrowScreen(): boolean {
@@ -67,7 +66,14 @@ const ALL_TABS = [
     id: "skills" as SettingsTab,
     label: "Skills",
     icon: SkillIcon,
-    description: "Custom Claude sub-agents",
+    description: "Custom Claude skills",
+    beta: true,
+  },
+  {
+    id: "agents" as SettingsTab,
+    label: "Custom Agents",
+    icon: AgentIcon,
+    description: "Manage custom Claude agents",
     beta: true,
   },
   // Debug tab - always shown in desktop for development
@@ -195,6 +201,8 @@ export function AgentsSettingsDialog({
         return <AgentsPreferencesTab />
       case "skills":
         return <AgentsSkillsTab />
+      case "agents":
+        return <AgentsCustomAgentsTab />
       case "debug":
         return isDevelopment ? <AgentsDebugTab /> : null
       default:
diff --git a/src/renderer/components/dialogs/settings-tabs/agent-dialog.tsx b/src/renderer/components/dialogs/settings-tabs/agent-dialog.tsx
new file mode 100644
index 0000000..c618ac1
--- /dev/null
+++ b/src/renderer/components/dialogs/settings-tabs/agent-dialog.tsx
@@ -0,0 +1,368 @@
+import { useState, useEffect } from "react"
+import { X } from "lucide-react"
+import { motion, AnimatePresence } from "motion/react"
+import { createPortal } from "react-dom"
+import { trpc } from "../../../lib/trpc"
+import { cn } from "../../../lib/utils"
+import { ToolSelector } from "./tool-selector"
+
+interface FileAgent {
+  name: string
+  description: string
+  prompt: string
+  tools?: string[]
+  disallowedTools?: string[]
+  model?: "sonnet" | "opus" | "haiku" | "inherit"
+  source: "user" | "project"
+  path: string
+}
+
+interface AgentDialogProps {
+  open: boolean
+  onOpenChange: (open: boolean) => void
+  agent: FileAgent | null
+  onSuccess: () => void
+}
+
+type ToolMode = "all" | "allowlist" | "denylist"
+
+export function AgentDialog({ open, onOpenChange, agent, onSuccess }: AgentDialogProps) {
+  const [mounted, setMounted] = useState(false)
+  const [portalTarget, setPortalTarget] = useState<HTMLElement | null>(null)
+
+  // Form state
+  const [name, setName] = useState("")
+  const [description, setDescription] = useState("")
+  const [prompt, setPrompt] = useState("")
+  const [model, setModel] = useState<"sonnet" | "opus" | "haiku" | "inherit">("inherit")
+  const [source, setSource] = useState<"user" | "project">("user")
+  const [toolMode, setToolMode] = useState<ToolMode>("all")
+  const [selectedTools, setSelectedTools] = useState<string[]>([])
+
+  const createMutation = trpc.agents.create.useMutation({
+    onSuccess: () => {
+      onSuccess()
+      resetForm()
+    },
+  })
+
+  const updateMutation = trpc.agents.update.useMutation({
+    onSuccess: () => {
+      onSuccess()
+      resetForm()
+    },
+  })
+
+  const isEditing = agent !== null
+  const isLoading = createMutation.isPending || updateMutation.isPending
+
+  // Initialize form when editing
+  useEffect(() => {
+    if (agent) {
+      setName(agent.name)
+      setDescription(agent.description)
+      setPrompt(agent.prompt)
+      setModel(agent.model || "inherit")
+      setSource(agent.source)
+
+      if (agent.tools && agent.tools.length > 0) {
+        setToolMode("allowlist")
+        setSelectedTools(agent.tools)
+      } else if (agent.disallowedTools && agent.disallowedTools.length > 0) {
+        setToolMode("denylist")
+        setSelectedTools(agent.disallowedTools)
+      } else {
+        setToolMode("all")
+        setSelectedTools([])
+      }
+    } else {
+      resetForm()
+    }
+  }, [agent, open])
+
+  // Ensure portal target only accessed on client
+  useEffect(() => {
+    setMounted(true)
+    if (typeof document !== "undefined") {
+      setPortalTarget(document.body)
+    }
+  }, [])
+
+  // Handle escape key
+  useEffect(() => {
+    if (!open) return
+
+    const handleKeyDown = (event: KeyboardEvent) => {
+      if (event.key === "Escape") {
+        event.preventDefault()
+        onOpenChange(false)
+      }
+    }
+
+    document.addEventListener("keydown", handleKeyDown)
+    return () => document.removeEventListener("keydown", handleKeyDown)
+  }, [open, onOpenChange])
+
+  const resetForm = () => {
+    setName("")
+    setDescription("")
+    setPrompt("")
+    setModel("inherit")
+    setSource("user")
+    setToolMode("all")
+    setSelectedTools([])
+  }
+
+  const handleSubmit = (e: React.FormEvent) => {
+    e.preventDefault()
+
+    const tools = toolMode === "allowlist" ? selectedTools : undefined
+    const disallowedTools = toolMode === "denylist" ? selectedTools : undefined
+
+    if (isEditing) {
+      updateMutation.mutate({
+        originalName: agent.name,
+        name: name.toLowerCase().replace(/\s+/g, "-"),
+        description,
+        prompt,
+        tools,
+        disallowedTools,
+        model,
+        source: agent.source,
+      })
+    } else {
+      createMutation.mutate({
+        name: name.toLowerCase().replace(/\s+/g, "-"),
+        description,
+        prompt,
+        tools,
+        disallowedTools,
+        model,
+        source,
+      })
+    }
+  }
+
+  const isValid = name.trim() && description.trim() && prompt.trim()
+
+  if (!mounted || !portalTarget || !open) return null
+
+  return createPortal(
+    <AnimatePresence mode="wait">
+      {open && (
+        <>
+          {/* Overlay */}
+          <motion.div
+            initial={{ opacity: 0 }}
+            animate={{ opacity: 1 }}
+            exit={{ opacity: 0 }}
+            transition={{ duration: 0.2 }}
+            className="fixed inset-0 z-[60] bg-black/50"
+            onClick={() => onOpenChange(false)}
+          />
+
+          {/* Dialog */}
+          <div className="fixed top-[50%] left-[50%] translate-x-[-50%] translate-y-[-50%] z-[65]">
+            <motion.div
+              initial={{ scale: 0.95, opacity: 0 }}
+              animate={{ scale: 1, opacity: 1 }}
+              exit={{ scale: 0.95, opacity: 0 }}
+              transition={{ duration: 0.2 }}
+              className="w-[90vw] max-w-[600px] max-h-[85vh] flex flex-col rounded-xl bg-background border border-border shadow-2xl overflow-hidden"
+              role="dialog"
+              aria-modal="true"
+            >
+              {/* Header */}
+              <div className="flex items-center justify-between px-6 py-4 border-b border-border">
+                <h2 className="text-lg font-semibold text-foreground">
+                  {isEditing ? "Edit Agent" : "Create Agent"}
+                </h2>
+                <button
+                  onClick={() => onOpenChange(false)}
+                  className="flex items-center justify-center h-8 w-8 rounded-full hover:bg-foreground/5 transition-colors"
+                >
+                  <X className="h-4 w-4" />
+                </button>
+              </div>
+
+              {/* Content */}
+              <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-6 space-y-5">
+                {/* Name */}
+                <div className="space-y-1.5">
+                  <label className="text-sm font-medium text-foreground">
+                    Name <span className="text-red-500">*</span>
+                  </label>
+                  <input
+                    type="text"
+                    value={name}
+                    onChange={(e) => setName(e.target.value)}
+                    placeholder="code-reviewer"
+                    className="w-full px-3 py-2 text-sm rounded-md border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
+                  />
+                  <p className="text-xs text-muted-foreground">
+                    Will be converted to kebab-case (e.g., "code-reviewer")
+                  </p>
+                </div>
+
+                {/* Description */}
+                <div className="space-y-1.5">
+                  <label className="text-sm font-medium text-foreground">
+                    Description <span className="text-red-500">*</span>
+                  </label>
+                  <input
+                    type="text"
+                    value={description}
+                    onChange={(e) => setDescription(e.target.value)}
+                    placeholder="Reviews code for quality and best practices"
+                    className="w-full px-3 py-2 text-sm rounded-md border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
+                  />
+                  <p className="text-xs text-muted-foreground">
+                    Tells Claude when to use this agent
+                  </p>
+                </div>
+
+                {/* Prompt */}
+                <div className="space-y-1.5">
+                  <label className="text-sm font-medium text-foreground">
+                    System Prompt <span className="text-red-500">*</span>
+                  </label>
+                  <textarea
+                    value={prompt}
+                    onChange={(e) => setPrompt(e.target.value)}
+                    placeholder="You are an expert code reviewer. When invoked:
+
+1. Analyze the code structure
+2. Check for security issues
+3. Suggest improvements"
+                    rows={8}
+                    className="w-full px-3 py-2 text-sm rounded-md border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring resize-none font-mono"
+                  />
+                  <p className="text-xs text-muted-foreground">
+                    Instructions for the agent when it's invoked
+                  </p>
+                </div>
+
+                {/* Model */}
+                <div className="space-y-1.5">
+                  <label className="text-sm font-medium text-foreground">Model</label>
+                  <div className="flex flex-wrap gap-2">
+                    {(["inherit", "sonnet", "opus", "haiku"] as const).map((m) => (
+                      <button
+                        key={m}
+                        type="button"
+                        onClick={() => setModel(m)}
+                        className={cn(
+                          "px-3 py-1.5 text-sm rounded-md border transition-colors",
+                          model === m
+                            ? "border-foreground/30 bg-foreground/10 text-foreground"
+                            : "border-border bg-background text-muted-foreground hover:border-foreground/20"
+                        )}
+                      >
+                        {m === "inherit" ? "Inherit (default)" : m.charAt(0).toUpperCase() + m.slice(1)}
+                      </button>
+                    ))}
+                  </div>
+                </div>
+
+                {/* Tools */}
+                <div className="space-y-3">
+                  <label className="text-sm font-medium text-foreground">Tools</label>
+                  <div className="flex flex-wrap gap-2">
+                    {(["all", "allowlist", "denylist"] as const).map((mode) => (
+                      <button
+                        key={mode}
+                        type="button"
+                        onClick={() => {
+                          setToolMode(mode)
+                          if (mode === "all") setSelectedTools([])
+                        }}
+                        className={cn(
+                          "px-3 py-1.5 text-sm rounded-md border transition-colors",
+                          toolMode === mode
+                            ? "border-foreground/30 bg-foreground/10 text-foreground"
+                            : "border-border bg-background text-muted-foreground hover:border-foreground/20"
+                        )}
+                      >
+                        {mode === "all" && "All Tools"}
+                        {mode === "allowlist" && "Only Selected"}
+                        {mode === "denylist" && "Except Selected"}
+                      </button>
+                    ))}
+                  </div>
+
+                  {toolMode !== "all" && (
+                    <ToolSelector
+                      selectedTools={selectedTools}
+                      onChange={setSelectedTools}
+                      mode={toolMode}
+                    />
+                  )}
+                </div>
+
+                {/* Source (only for new agents) */}
+                {!isEditing && (
+                  <div className="space-y-1.5">
+                    <label className="text-sm font-medium text-foreground">Location</label>
+                    <div className="flex flex-wrap gap-2">
+                      <button
+                        type="button"
+                        onClick={() => setSource("user")}
+                        className={cn(
+                          "px-3 py-1.5 text-sm rounded-md border transition-colors",
+                          source === "user"
+                            ? "border-foreground/30 bg-foreground/10 text-foreground"
+                            : "border-border bg-background text-muted-foreground hover:border-foreground/20"
+                        )}
+                      >
+                        User (~/.claude/agents/)
+                      </button>
+                      <button
+                        type="button"
+                        onClick={() => setSource("project")}
+                        className={cn(
+                          "px-3 py-1.5 text-sm rounded-md border transition-colors",
+                          source === "project"
+                            ? "border-foreground/30 bg-foreground/10 text-foreground"
+                            : "border-border bg-background text-muted-foreground hover:border-foreground/20"
+                        )}
+                      >
+                        Project (.claude/agents/)
+                      </button>
+                    </div>
+                    <p className="text-xs text-muted-foreground">
+                      User agents are available globally, project agents only in the current project
+                    </p>
+                  </div>
+                )}
+              </form>
+
+              {/* Footer */}
+              <div className="flex items-center justify-end gap-3 px-6 py-4 border-t border-border">
+                <button
+                  type="button"
+                  onClick={() => onOpenChange(false)}
+                  className="px-4 py-2 text-sm font-medium rounded-md border border-border bg-background text-foreground hover:bg-foreground/5 transition-colors"
+                >
+                  Cancel
+                </button>
+                <button
+                  onClick={handleSubmit}
+                  disabled={!isValid || isLoading}
+                  className={cn(
+                    "px-4 py-2 text-sm font-medium rounded-md transition-colors",
+                    isValid && !isLoading
+                      ? "bg-foreground text-background hover:bg-foreground/90"
+                      : "bg-foreground/50 text-background/70 cursor-not-allowed"
+                  )}
+                >
+                  {isLoading ? "Saving..." : isEditing ? "Save Changes" : "Create Agent"}
+                </button>
+              </div>
+            </motion.div>
+          </div>
+        </>
+      )}
+    </AnimatePresence>,
+    portalTarget
+  )
+}
diff --git a/src/renderer/components/dialogs/settings-tabs/agents-custom-agents-tab.tsx b/src/renderer/components/dialogs/settings-tabs/agents-custom-agents-tab.tsx
new file mode 100644
index 0000000..a994ce1
--- /dev/null
+++ b/src/renderer/components/dialogs/settings-tabs/agents-custom-agents-tab.tsx
@@ -0,0 +1,282 @@
+import { useState, useEffect } from "react"
+import { ChevronRight } from "lucide-react"
+import { motion, AnimatePresence } from "motion/react"
+import { trpc } from "../../../lib/trpc"
+import { cn } from "../../../lib/utils"
+import { AgentIcon } from "../../ui/icons"
+
+// Hook to detect narrow screen
+function useIsNarrowScreen(): boolean {
+  const [isNarrow, setIsNarrow] = useState(false)
+
+  useEffect(() => {
+    const checkWidth = () => {
+      setIsNarrow(window.innerWidth <= 768)
+    }
+
+    checkWidth()
+    window.addEventListener("resize", checkWidth)
+    return () => window.removeEventListener("resize", checkWidth)
+  }, [])
+
+  return isNarrow
+}
+
+interface FileAgent {
+  name: string
+  description: string
+  prompt: string
+  tools?: string[]
+  disallowedTools?: string[]
+  model?: "sonnet" | "opus" | "haiku" | "inherit"
+  source: "user" | "project"
+  path: string
+}
+
+export function AgentsCustomAgentsTab() {
+  const isNarrowScreen = useIsNarrowScreen()
+  const [expandedAgentName, setExpandedAgentName] = useState<string | null>(null)
+
+  const { data: agents = [], isLoading } = trpc.agents.list.useQuery(undefined)
+
+  const openInFinderMutation = trpc.external.openInFinder.useMutation()
+
+  const userAgents = agents.filter((a) => a.source === "user")
+  const projectAgents = agents.filter((a) => a.source === "project")
+
+  const handleExpandAgent = (agentName: string) => {
+    setExpandedAgentName(expandedAgentName === agentName ? null : agentName)
+  }
+
+  const handleOpenInFinder = (path: string) => {
+    openInFinderMutation.mutate(path)
+  }
+
+  return (
+    <div className="p-6 space-y-6 overflow-y-auto max-h-[70vh]">
+      {/* Header - hidden on narrow screens */}
+      {!isNarrowScreen && (
+        <div className="flex flex-col space-y-1.5 text-center sm:text-left">
+          <div className="flex items-center gap-2">
+            <h3 className="text-sm font-semibold text-foreground">Custom Agents</h3>
+            <span className="px-1.5 py-0.5 text-[10px] font-medium rounded bg-muted text-muted-foreground">
+              Beta
+            </span>
+          </div>
+          <a
+            href="https://code.claude.com/docs/en/sub-agents"
+            target="_blank"
+            rel="noopener noreferrer"
+            className="text-xs text-muted-foreground hover:text-foreground underline transition-colors"
+          >
+            Documentation
+          </a>
+        </div>
+      )}
+
+      {/* Agents List */}
+      <div className="space-y-4">
+        {isLoading ? (
+          <div className="bg-background rounded-lg border border-border p-4 text-sm text-muted-foreground text-center">
+            Loading agents...
+          </div>
+        ) : agents.length === 0 ? (
+          <div className="bg-background rounded-lg border border-border p-6 text-center">
+            <AgentIcon className="h-8 w-8 text-muted-foreground/50 mx-auto mb-3" />
+            <p className="text-sm text-muted-foreground mb-2">
+              No custom agents found
+            </p>
+            <p className="text-xs text-muted-foreground">
+              Add .md files to <code className="px-1 py-0.5 bg-muted rounded">~/.claude/agents/</code>
+            </p>
+          </div>
+        ) : (
+          <>
+            {/* User Agents */}
+            {userAgents.length > 0 && (
+              <div className="space-y-2">
+                <div className="text-xs text-muted-foreground">
+                  ~/.claude/agents/
+                </div>
+                <div className="bg-background rounded-lg border border-border overflow-hidden">
+                  <div className="divide-y divide-border">
+                    {userAgents.map((agent) => (
+                      <AgentRow
+                        key={agent.name}
+                        agent={agent}
+                        isExpanded={expandedAgentName === agent.name}
+                        onToggle={() => handleExpandAgent(agent.name)}
+                        onOpenInFinder={() => handleOpenInFinder(agent.path)}
+                      />
+                    ))}
+                  </div>
+                </div>
+              </div>
+            )}
+
+            {/* Project Agents */}
+            {projectAgents.length > 0 && (
+              <div className="space-y-2">
+                <div className="text-xs text-muted-foreground">
+                  .claude/agents/
+                </div>
+                <div className="bg-background rounded-lg border border-border overflow-hidden">
+                  <div className="divide-y divide-border">
+                    {projectAgents.map((agent) => (
+                      <AgentRow
+                        key={agent.name}
+                        agent={agent}
+                        isExpanded={expandedAgentName === agent.name}
+                        onToggle={() => handleExpandAgent(agent.name)}
+                        onOpenInFinder={() => handleOpenInFinder(agent.path)}
+                      />
+                    ))}
+                  </div>
+                </div>
+              </div>
+            )}
+          </>
+        )}
+      </div>
+
+      {/* Info Section */}
+      <div className="pt-4 border-t border-border space-y-3">
+        <div>
+          <h4 className="text-xs font-medium text-foreground mb-1.5">
+            How Custom Agents Work
+          </h4>
+          <p className="text-xs text-muted-foreground">
+            Agents are specialized sub-agents that Claude can invoke via the Task tool. They have their own system prompt, tools, and model settings.
+          </p>
+        </div>
+        <div>
+          <h4 className="text-xs font-medium text-foreground mb-1.5">
+            Using Agents
+          </h4>
+          <p className="text-xs text-muted-foreground">
+            Ask Claude to use an agent directly (e.g., "use the code-reviewer agent") or Claude will automatically invoke them when appropriate.
+          </p>
+        </div>
+        <div>
+          <h4 className="text-xs font-medium text-foreground mb-1.5">
+            File Format
+          </h4>
+          <p className="text-xs text-muted-foreground">
+            Agents are Markdown files with YAML frontmatter containing <code className="px-1 py-0.5 bg-muted rounded">name</code>, <code className="px-1 py-0.5 bg-muted rounded">description</code>, <code className="px-1 py-0.5 bg-muted rounded">tools</code>, and <code className="px-1 py-0.5 bg-muted rounded">model</code>. The body is the system prompt.
+          </p>
+        </div>
+      </div>
+
+    </div>
+  )
+}
+
+function AgentRow({
+  agent,
+  isExpanded,
+  onToggle,
+  onOpenInFinder,
+}: {
+  agent: FileAgent
+  isExpanded: boolean
+  onToggle: () => void
+  onOpenInFinder: () => void
+}) {
+  return (
+    <div>
+      <button
+        onClick={onToggle}
+        className="w-full flex items-center gap-3 p-4 text-left hover:bg-muted/30 transition-colors"
+      >
+        <ChevronRight
+          className={cn(
+            "h-4 w-4 text-muted-foreground transition-transform flex-shrink-0",
+            isExpanded && "rotate-90",
+          )}
+        />
+        <div className="flex flex-col space-y-0.5 min-w-0 flex-1">
+          <span className="text-sm font-medium text-foreground truncate">
+            {agent.name}
+          </span>
+          {agent.description && (
+            <span className="text-xs text-muted-foreground truncate">
+              {agent.description}
+            </span>
+          )}
+        </div>
+        {agent.model && agent.model !== "inherit" && (
+          <span className="px-1.5 py-0.5 text-[10px] font-medium rounded bg-muted text-muted-foreground flex-shrink-0">
+            {agent.model}
+          </span>
+        )}
+      </button>
+
+      <AnimatePresence initial={false}>
+        {isExpanded && (
+          <motion.div
+            initial={{ height: 0, opacity: 0 }}
+            animate={{ height: "auto", opacity: 1 }}
+            exit={{ height: 0, opacity: 0 }}
+            transition={{
+              height: { type: "spring", stiffness: 300, damping: 30 },
+              opacity: { duration: 0.2 },
+            }}
+            className="overflow-hidden"
+          >
+            <div className="px-4 pb-4 pt-0 border-t border-border bg-muted/20">
+              <div className="pt-3 space-y-3">
+                {/* Path - clickable to open in Finder */}
+                <div>
+                  <span className="text-xs font-medium text-foreground">Path</span>
+                  <button
+                    onClick={(e) => {
+                      e.stopPropagation()
+                      onOpenInFinder()
+                    }}
+                    className="block text-xs text-muted-foreground font-mono mt-0.5 break-all text-left hover:text-foreground hover:underline transition-colors cursor-pointer"
+                  >
+                    {agent.path}
+                  </button>
+                </div>
+
+                {/* Tools */}
+                {agent.tools && agent.tools.length > 0 && (
+                  <div>
+                    <span className="text-xs font-medium text-foreground">Allowed Tools</span>
+                    <div className="flex flex-wrap gap-1 mt-1">
+                      {agent.tools.map((tool) => (
+                        <span
+                          key={tool}
+                          className="px-1.5 py-0.5 text-[10px] font-medium rounded bg-muted text-muted-foreground"
+                        >
+                          {tool}
+                        </span>
+                      ))}
+                    </div>
+                  </div>
+                )}
+
+                {/* Disallowed Tools */}
+                {agent.disallowedTools && agent.disallowedTools.length > 0 && (
+                  <div>
+                    <span className="text-xs font-medium text-foreground">Disallowed Tools</span>
+                    <div className="flex flex-wrap gap-1 mt-1">
+                      {agent.disallowedTools.map((tool) => (
+                        <span
+                          key={tool}
+                          className="px-1.5 py-0.5 text-[10px] font-medium rounded bg-muted text-muted-foreground"
+                        >
+                          {tool}
+                        </span>
+                      ))}
+                    </div>
+                  </div>
+                )}
+              </div>
+            </div>
+          </motion.div>
+        )}
+      </AnimatePresence>
+    </div>
+  )
+}
diff --git a/src/renderer/components/dialogs/settings-tabs/agents-skills-tab.tsx b/src/renderer/components/dialogs/settings-tabs/agents-skills-tab.tsx
index 1b4cd7b..2f7eee5 100644
--- a/src/renderer/components/dialogs/settings-tabs/agents-skills-tab.tsx
+++ b/src/renderer/components/dialogs/settings-tabs/agents-skills-tab.tsx
@@ -27,6 +27,7 @@ export function AgentsSkillsTab() {
   const [expandedSkillName, setExpandedSkillName] = useState<string | null>(null)
 
   const { data: skills = [], isLoading } = trpc.skills.list.useQuery(undefined)
+  const openInFinderMutation = trpc.external.openInFinder.useMutation()
 
   const userSkills = skills.filter((s) => s.source === "user")
   const projectSkills = skills.filter((s) => s.source === "project")
@@ -35,6 +36,10 @@ export function AgentsSkillsTab() {
     setExpandedSkillName(expandedSkillName === skillName ? null : skillName)
   }
 
+  const handleOpenInFinder = (path: string) => {
+    openInFinderMutation.mutate(path)
+  }
+
   return (
     <div className="p-6 space-y-6 overflow-y-auto max-h-[70vh]">
       {/* Header - hidden on narrow screens */}
@@ -89,6 +94,7 @@ export function AgentsSkillsTab() {
                         skill={skill}
                         isExpanded={expandedSkillName === skill.name}
                         onToggle={() => handleExpandSkill(skill.name)}
+                        onOpenInFinder={() => handleOpenInFinder(skill.path)}
                       />
                     ))}
                   </div>
@@ -110,6 +116,7 @@ export function AgentsSkillsTab() {
                         skill={skill}
                         isExpanded={expandedSkillName === skill.name}
                         onToggle={() => handleExpandSkill(skill.name)}
+                        onOpenInFinder={() => handleOpenInFinder(skill.path)}
                       />
                     ))}
                   </div>
@@ -147,10 +154,12 @@ function SkillRow({
   skill,
   isExpanded,
   onToggle,
+  onOpenInFinder,
 }: {
   skill: { name: string; description: string; source: "user" | "project"; path: string }
   isExpanded: boolean
   onToggle: () => void
+  onOpenInFinder: () => void
 }) {
   return (
     <div>
@@ -192,9 +201,15 @@ function SkillRow({
               <div className="pt-3 space-y-2">
                 <div>
                   <span className="text-xs font-medium text-foreground">Path</span>
-                  <p className="text-xs text-muted-foreground font-mono mt-0.5 break-all">
+                  <button
+                    onClick={(e) => {
+                      e.stopPropagation()
+                      onOpenInFinder()
+                    }}
+                    className="block text-xs text-muted-foreground font-mono mt-0.5 break-all text-left hover:text-foreground hover:underline transition-colors cursor-pointer"
+                  >
                     {skill.path}
-                  </p>
+                  </button>
                 </div>
                 <div>
                   <span className="text-xs font-medium text-foreground">Usage</span>
diff --git a/src/renderer/components/dialogs/settings-tabs/index.ts b/src/renderer/components/dialogs/settings-tabs/index.ts
index 41261a0..ec082a6 100644
--- a/src/renderer/components/dialogs/settings-tabs/index.ts
+++ b/src/renderer/components/dialogs/settings-tabs/index.ts
@@ -2,3 +2,4 @@ export { AgentsAppearanceTab } from "./agents-appearance-tab"
 export { AgentsProfileTab } from "./agents-profile-tab"
 export { AgentsDebugTab } from "./agents-debug-tab"
 export { AgentsSkillsTab } from "./agents-skills-tab"
+export { AgentsCustomAgentsTab } from "./agents-custom-agents-tab"
diff --git a/src/renderer/components/dialogs/settings-tabs/tool-selector.tsx b/src/renderer/components/dialogs/settings-tabs/tool-selector.tsx
new file mode 100644
index 0000000..bb361fa
--- /dev/null
+++ b/src/renderer/components/dialogs/settings-tabs/tool-selector.tsx
@@ -0,0 +1,159 @@
+import { cn } from "../../../lib/utils"
+
+export const AVAILABLE_TOOLS = [
+  // File Operations
+  { id: "Read", name: "Read File", category: "file", description: "Read file contents" },
+  { id: "Write", name: "Write File", category: "file", description: "Create or overwrite files" },
+  { id: "Edit", name: "Edit File", category: "file", description: "Make precise edits" },
+  { id: "Glob", name: "Glob Pattern", category: "file", description: "Find files by pattern" },
+  { id: "Grep", name: "Search Content", category: "file", description: "Search in file contents" },
+  { id: "NotebookEdit", name: "Notebook Edit", category: "file", description: "Edit Jupyter notebooks" },
+
+  // System
+  { id: "Bash", name: "Bash Commands", category: "system", description: "Execute shell commands" },
+  { id: "Task", name: "Launch Subagent", category: "system", description: "Launch specialized agents" },
+
+  // Web
+  { id: "WebSearch", name: "Web Search", category: "web", description: "Search the internet" },
+  { id: "WebFetch", name: "Fetch URL", category: "web", description: "Fetch webpage content" },
+
+  // Planning & Interaction
+  { id: "TodoWrite", name: "Todo List", category: "planning", description: "Manage task list" },
+  { id: "AskUserQuestion", name: "Ask User", category: "planning", description: "Ask clarifying questions" },
+]
+
+const CATEGORIES = [
+  { id: "file", name: "File Operations" },
+  { id: "system", name: "System" },
+  { id: "web", name: "Web" },
+  { id: "planning", name: "Planning" },
+]
+
+interface ToolSelectorProps {
+  selectedTools: string[]
+  onChange: (tools: string[]) => void
+  mode: "allowlist" | "denylist"
+}
+
+export function ToolSelector({ selectedTools, onChange, mode }: ToolSelectorProps) {
+  const handleToggle = (toolId: string) => {
+    if (selectedTools.includes(toolId)) {
+      onChange(selectedTools.filter((t) => t !== toolId))
+    } else {
+      onChange([...selectedTools, toolId])
+    }
+  }
+
+  const handleSelectAll = () => {
+    onChange(AVAILABLE_TOOLS.map((t) => t.id))
+  }
+
+  const handleSelectNone = () => {
+    onChange([])
+  }
+
+  return (
+    <div className="space-y-3">
+      {/* Quick actions */}
+      <div className="flex items-center gap-2">
+        <button
+          type="button"
+          onClick={handleSelectAll}
+          className="text-xs text-muted-foreground hover:text-foreground transition-colors"
+        >
+          Select all
+        </button>
+        <span className="text-muted-foreground"></span>
+        <button
+          type="button"
+          onClick={handleSelectNone}
+          className="text-xs text-muted-foreground hover:text-foreground transition-colors"
+        >
+          Clear
+        </button>
+        <span className="flex-1" />
+        <span className="text-xs text-muted-foreground">
+          {selectedTools.length} selected
+        </span>
+      </div>
+
+      {/* Tools by category */}
+      <div className="space-y-4 p-3 rounded-lg border border-border bg-muted/20">
+        {CATEGORIES.map((category) => {
+          const categoryTools = AVAILABLE_TOOLS.filter((t) => t.category === category.id)
+          if (categoryTools.length === 0) return null
+
+          return (
+            <div key={category.id} className="space-y-2">
+              <div className="text-xs font-medium text-muted-foreground uppercase tracking-wide">
+                {category.name}
+              </div>
+              <div className="grid grid-cols-2 gap-2">
+                {categoryTools.map((tool) => {
+                  const isSelected = selectedTools.includes(tool.id)
+                  return (
+                    <button
+                      key={tool.id}
+                      type="button"
+                      onClick={() => handleToggle(tool.id)}
+                      className={cn(
+                        "flex items-start gap-2 p-2 rounded-md border text-left transition-colors",
+                        isSelected
+                          ? mode === "allowlist"
+                            ? "border-green-500/30 bg-green-500/10"
+                            : "border-red-500/30 bg-red-500/10"
+                          : "border-transparent bg-background hover:bg-foreground/5"
+                      )}
+                    >
+                      <div
+                        className={cn(
+                          "mt-0.5 h-3.5 w-3.5 rounded border flex items-center justify-center flex-shrink-0",
+                          isSelected
+                            ? mode === "allowlist"
+                              ? "border-green-500 bg-green-500"
+                              : "border-red-500 bg-red-500"
+                            : "border-muted-foreground/30"
+                        )}
+                      >
+                        {isSelected && (
+                          <svg
+                            className="h-2.5 w-2.5 text-white"
+                            fill="none"
+                            viewBox="0 0 24 24"
+                            stroke="currentColor"
+                            strokeWidth={3}
+                          >
+                            <path
+                              strokeLinecap="round"
+                              strokeLinejoin="round"
+                              d="M5 13l4 4L19 7"
+                            />
+                          </svg>
+                        )}
+                      </div>
+                      <div className="min-w-0">
+                        <div className="text-xs font-medium text-foreground truncate">
+                          {tool.name}
+                        </div>
+                        <div className="text-[10px] text-muted-foreground truncate">
+                          {tool.description}
+                        </div>
+                      </div>
+                    </button>
+                  )
+                })}
+              </div>
+            </div>
+          )
+        })}
+      </div>
+
+      {/* Hint */}
+      <p className="text-xs text-muted-foreground">
+        {mode === "allowlist"
+          ? "Agent will ONLY have access to selected tools"
+          : "Agent will have access to ALL tools EXCEPT selected ones"}
+      </p>
+    </div>
+  )
+}
diff --git a/src/renderer/features/agents/atoms/index.ts b/src/renderer/features/agents/atoms/index.ts
index 019eb0c..9a27ee1 100644
--- a/src/renderer/features/agents/atoms/index.ts
+++ b/src/renderer/features/agents/atoms/index.ts
@@ -449,3 +449,7 @@ export type PendingUserQuestions = {
   }>
 }
 export const pendingUserQuestionsAtom = atom<PendingUserQuestions | null>(null)
+
+// Store AskUserQuestion results by toolUseId for real-time updates
+// Map<toolUseId, result>
+export const askUserQuestionResultsAtom = atom<Map<string, unknown>>(new Map())
diff --git a/src/renderer/features/agents/lib/ipc-chat-transport.ts b/src/renderer/features/agents/lib/ipc-chat-transport.ts
index 24ba980..3a0c1ff 100644
--- a/src/renderer/features/agents/lib/ipc-chat-transport.ts
+++ b/src/renderer/features/agents/lib/ipc-chat-transport.ts
@@ -8,6 +8,7 @@ import {
 import { appStore } from "../../../lib/jotai-store"
 import { trpcClient } from "../../../lib/trpc"
 import {
+  askUserQuestionResultsAtom,
   lastSelectedModelIdAtom,
   MODEL_ID_MAP,
   pendingAuthRetryMessageAtom,
@@ -158,22 +159,8 @@ export class IPCChatTransport implements ChatTransport<UIMessage> {
               chunkCount++
               lastChunkType = chunk.type
 
-              // Debug: log all chunks when there's a pending question
-              const currentPending = appStore.get(pendingUserQuestionsAtom)
-              if (currentPending || chunk.type === "ask-user-question") {
-                console.log("[PendingQ] Transport chunk:", {
-                  type: chunk.type,
-                  hasPending: !!currentPending,
-                  chunkCount,
-                })
-              }
-
               // Handle AskUserQuestion - show question UI
               if (chunk.type === "ask-user-question") {
-                console.log("[PendingQ] Transport: Setting pending question", {
-                  subChatId: this.config.subChatId,
-                  toolUseId: chunk.toolUseId,
-                })
                 appStore.set(pendingUserQuestionsAtom, {
                   subChatId: this.config.subChatId,
                   toolUseId: chunk.toolUseId,
@@ -185,22 +172,32 @@ export class IPCChatTransport implements ChatTransport<UIMessage> {
               if (chunk.type === "ask-user-question-timeout") {
                 const pending = appStore.get(pendingUserQuestionsAtom)
                 if (pending && pending.toolUseId === chunk.toolUseId) {
-                  console.log("[PendingQ] Transport: Clearing timed out question", {
-                    toolUseId: chunk.toolUseId,
-                  })
                   appStore.set(pendingUserQuestionsAtom, null)
                 }
               }
 
-              // Clear pending questions on ANY other chunk type (agent moved on)
-              // Only clear if the pending question belongs to THIS sub-chat
-              if (chunk.type !== "ask-user-question" && chunk.type !== "ask-user-question-timeout") {
+              // Handle AskUserQuestion result - store for real-time updates
+              if (chunk.type === "ask-user-question-result") {
+                const currentResults = appStore.get(askUserQuestionResultsAtom)
+                const newResults = new Map(currentResults)
+                newResults.set(chunk.toolUseId, chunk.result)
+                appStore.set(askUserQuestionResultsAtom, newResults)
+              }
+
+              // Clear pending questions ONLY when agent has moved on
+              // Don't clear on tool-input-* chunks (still building the question input)
+              // Clear when we get tool-output-* (answer received) or text-delta (agent moved on)
+              const shouldClearOnChunk =
+                chunk.type !== "ask-user-question" &&
+                chunk.type !== "ask-user-question-timeout" &&
+                chunk.type !== "ask-user-question-result" &&
+                !chunk.type.startsWith("tool-input") && // Don't clear while input is being built
+                chunk.type !== "start" &&
+                chunk.type !== "start-step"
+
+              if (shouldClearOnChunk) {
                 const pending = appStore.get(pendingUserQuestionsAtom)
                 if (pending && pending.subChatId === this.config.subChatId) {
-                  console.log("[PendingQ] Transport: Clearing pending question", {
-                    chunkType: chunk.type,
-                    pendingToolUseId: pending.toolUseId,
-                  })
                   appStore.set(pendingUserQuestionsAtom, null)
                 }
               }
@@ -303,15 +300,9 @@ export class IPCChatTransport implements ChatTransport<UIMessage> {
             },
             onComplete: () => {
               console.log(`[SD] R:COMPLETE sub=${subId} n=${chunkCount} last=${lastChunkType}`)
-              // Fallback: clear any pending questions when stream completes
-              // This handles edge cases where timeout chunk wasn't received
-              const pending = appStore.get(pendingUserQuestionsAtom)
-              if (pending && pending.subChatId === this.config.subChatId) {
-                console.log("[PendingQ] Transport: Clearing pending question on stream complete (fallback)", {
-                  pendingToolUseId: pending.toolUseId,
-                })
-                appStore.set(pendingUserQuestionsAtom, null)
-              }
+              // Note: Don't clear pending questions here - let active-chat.tsx handle it
+              // via the stream stop detection effect. Clearing here causes race conditions
+              // where sync effect immediately restores from messages.
               try {
                 controller.close()
               } catch {
diff --git a/src/renderer/features/agents/main/active-chat.tsx b/src/renderer/features/agents/main/active-chat.tsx
index 1aa7473..5ac1722 100644
--- a/src/renderer/features/agents/main/active-chat.tsx
+++ b/src/renderer/features/agents/main/active-chat.tsx
@@ -971,6 +971,11 @@ function ChatViewInner({
   const [mentionSearchText, setMentionSearchText] = useState("")
   const [mentionPosition, setMentionPosition] = useState({ top: 0, left: 0 })
 
+  // Mention dropdown subpage navigation state
+  const [showingFilesList, setShowingFilesList] = useState(false)
+  const [showingSkillsList, setShowingSkillsList] = useState(false)
+  const [showingAgentsList, setShowingAgentsList] = useState(false)
+
   // Slash command dropdown state
   const [showSlashDropdown, setShowSlashDropdown] = useState(false)
   const [slashSearchText, setSlashSearchText] = useState("")
@@ -1168,6 +1173,47 @@ function ChatViewInner({
     [messages],
   )
 
+  // Track previous streaming state to detect stream stop
+  const prevIsStreamingRef = useRef(isStreaming)
+  // Track if we recently stopped streaming (to prevent sync effect from restoring)
+  const recentlyStoppedStreamRef = useRef(false)
+
+  // Clear pending questions when streaming is aborted
+  // This effect runs when isStreaming transitions from true to false
+  useEffect(() => {
+    const wasStreaming = prevIsStreamingRef.current
+    prevIsStreamingRef.current = isStreaming
+
+    // Detect streaming stop transition
+    if (wasStreaming && !isStreaming) {
+      // Mark that we recently stopped streaming
+      recentlyStoppedStreamRef.current = true
+      // Clear the flag after a delay
+      const flagTimeout = setTimeout(() => {
+        recentlyStoppedStreamRef.current = false
+      }, 500)
+
+      // Streaming just stopped - if there's a pending question for this chat,
+      // clear it after a brief delay (backend already handled the abort)
+      if (pendingQuestions?.subChatId === subChatId) {
+        const timeout = setTimeout(() => {
+          // Re-check if still showing the same question (might have been cleared by other means)
+          setPendingQuestions((current) => {
+            if (current?.subChatId === subChatId) {
+              return null
+            }
+            return current
+          })
+        }, 150) // Small delay to allow for race conditions with transport chunks
+        return () => {
+          clearTimeout(timeout)
+          clearTimeout(flagTimeout)
+        }
+      }
+      return () => clearTimeout(flagTimeout)
+    }
+  }, [isStreaming, subChatId, pendingQuestions?.subChatId, pendingQuestions?.toolUseId, setPendingQuestions])
+
   // Sync pending questions with messages state
   // This handles: 1) restoring on chat switch, 2) clearing when question is answered/timed out
   useEffect(() => {
@@ -1181,6 +1227,7 @@ function ChatViewInner({
         part.input?.questions,
     ) as any | undefined
 
+
     // If streaming and we already have a pending question for this chat, keep it
     // (transport will manage it via chunks)
     if (isStreaming && pendingQuestions?.subChatId === subChatId) {
@@ -1202,18 +1249,17 @@ function ChatViewInner({
       return
     }
 
-    // Not streaming - restore or clear based on messages
+    // Not streaming - DON'T restore pending questions from messages
+    // If stream is not active, the question is either:
+    // 1. Already answered (state would be "output-available")
+    // 2. Interrupted/aborted (should not show dialog)
+    // 3. Timed out (should not show dialog)
+    // We only show the question dialog during active streaming when
+    // the backend is waiting for user response.
     if (pendingQuestionPart) {
-      // Found pending question - set it (or update if different)
-      if (
-        pendingQuestions?.subChatId !== subChatId ||
-        pendingQuestions?.toolUseId !== pendingQuestionPart.toolCallId
-      ) {
-        setPendingQuestions({
-          subChatId,
-          toolUseId: pendingQuestionPart.toolCallId,
-          questions: pendingQuestionPart.input.questions,
-        })
+      // Don't restore - if there's an existing pending question for this chat, clear it
+      if (pendingQuestions?.subChatId === subChatId) {
+        setPendingQuestions(null)
       }
     } else {
       // No pending question - clear if belongs to this sub-chat
@@ -1240,12 +1286,22 @@ function ChatViewInner({
   // Handle skipping questions
   const handleQuestionsSkip = useCallback(async () => {
     if (!pendingQuestions) return
-    await trpcClient.claude.respondToolApproval.mutate({
-      toolUseId: pendingQuestions.toolUseId,
-      approved: false,
-      message: QUESTIONS_SKIPPED_MESSAGE,
-    })
+    const toolUseId = pendingQuestions.toolUseId
+
+    // Clear UI immediately - don't wait for backend
+    // This ensures dialog closes even if stream was already aborted
     setPendingQuestions(null)
+
+    // Try to notify backend (may fail if already aborted - that's ok)
+    try {
+      await trpcClient.claude.respondToolApproval.mutate({
+        toolUseId,
+        approved: false,
+        message: QUESTIONS_SKIPPED_MESSAGE,
+      })
+    } catch {
+      // Stream likely already aborted - ignore
+    }
   }, [pendingQuestions, setPendingQuestions])
 
   // Watch for pending auth retry message (after successful OAuth flow)
@@ -1686,8 +1742,29 @@ function ChatViewInner({
   }
 
   const handleMentionSelect = useCallback((mention: FileMentionOption) => {
+    // Category navigation - enter subpage instead of inserting mention
+    if (mention.type === "category") {
+      if (mention.id === "files") {
+        setShowingFilesList(true)
+        return
+      }
+      if (mention.id === "skills") {
+        setShowingSkillsList(true)
+        return
+      }
+      if (mention.id === "agents") {
+        setShowingAgentsList(true)
+        return
+      }
+    }
+
+    // Otherwise: insert mention as normal
     editorRef.current?.insertMention(mention)
     setShowMentionDropdown(false)
+    // Reset subpage state
+    setShowingFilesList(false)
+    setShowingSkillsList(false)
+    setShowingAgentsList(false)
   }, [])
 
   // Slash command handlers
@@ -2363,6 +2440,8 @@ function ChatViewInner({
                             }
                             state={isPending ? "call" : "result"}
                             isError={isError}
+                            isStreaming={isStreaming && isLastMessage}
+                            toolCallId={part.toolCallId}
                           />
                         )
                       }
@@ -2675,7 +2754,13 @@ function ChatViewInner({
                         setShowMentionDropdown(true)
                       }
                     }}
-                    onCloseTrigger={() => setShowMentionDropdown(false)}
+                    onCloseTrigger={() => {
+                      setShowMentionDropdown(false)
+                      // Reset subpage state when closing
+                      setShowingFilesList(false)
+                      setShowingSkillsList(false)
+                      setShowingAgentsList(false)
+                    }}
                     onSlashTrigger={handleSlashTrigger}
                     onCloseSlashTrigger={handleCloseSlashTrigger}
                     onContentChange={setHasContent}
@@ -2995,7 +3080,13 @@ function ChatViewInner({
             showMentionDropdown &&
             (!!projectPath || !!repository || !!sandboxId)
           }
-          onClose={() => setShowMentionDropdown(false)}
+          onClose={() => {
+            setShowMentionDropdown(false)
+            // Reset subpage state when closing
+            setShowingFilesList(false)
+            setShowingSkillsList(false)
+            setShowingAgentsList(false)
+          }}
           onSelect={handleMentionSelect}
           searchText={mentionSearchText}
           position={mentionPosition}
@@ -3004,6 +3095,10 @@ function ChatViewInner({
           sandboxId={sandboxId}
           projectPath={projectPath}
           changedFiles={changedFilesForSubChat}
+          // Subpage navigation state
+          showingFilesList={showingFilesList}
+          showingSkillsList={showingSkillsList}
+          showingAgentsList={showingAgentsList}
         />
 
         {/* Slash command dropdown */}
diff --git a/src/renderer/features/agents/mentions/agents-file-mention.tsx b/src/renderer/features/agents/mentions/agents-file-mention.tsx
index fb03fa7..bef1a29 100644
--- a/src/renderer/features/agents/mentions/agents-file-mention.tsx
+++ b/src/renderer/features/agents/mentions/agents-file-mention.tsx
@@ -22,7 +22,15 @@ import {
   FilesIcon,
   IconSpinner,
   SkillIcon,
+  AgentIcon,
 } from "../../../components/ui/icons"
+import { ChevronRight } from "lucide-react"
+import {
+  Tooltip,
+  TooltipContent,
+  TooltipProvider,
+  TooltipTrigger,
+} from "../../../components/ui/tooltip"
 
 // Custom folder icon matching design
 function FolderOpenIcon({ className }: { className?: string }) {
@@ -95,8 +103,19 @@ interface AgentsFileMentionProps {
   branch?: string // For fetching files from specific branch via GitHub API
   projectPath?: string // For fetching files from local project directory (desktop)
   changedFiles?: ChangedFile[] // Files changed in current sub-chat (shown at top)
+  // Subpage navigation state
+  showingFilesList?: boolean
+  showingSkillsList?: boolean
+  showingAgentsList?: boolean
 }
 
+// Category navigation options (shown on root view)
+const CATEGORY_OPTIONS: FileMentionOption[] = [
+  { id: "files", label: "Files & Folders", type: "category", path: "", repository: "" },
+  { id: "skills", label: "Skills", type: "category", path: "", repository: "" },
+  { id: "agents", label: "Agents", type: "category", path: "", repository: "" },
+]
+
 // Known file extensions with icons
 const KNOWN_FILE_ICON_EXTENSIONS = new Set([
   "tsx",
@@ -290,12 +309,16 @@ export function getFileIconByExtension(
 }
 
 // Create SVG icon element in DOM based on file extension or type
-export function createFileIconElement(filename: string, type?: "file" | "folder" | "skill"): SVGSVGElement {
+export function createFileIconElement(filename: string, type?: "file" | "folder" | "skill" | "agent" | "category"): SVGSVGElement {
   const IconComponent = type === "skill"
     ? SkillIcon
-    : type === "folder" 
-      ? FolderOpenIcon 
+    : type === "agent"
+      ? AgentIcon
+    : type === "folder"
+      ? FolderOpenIcon
       : (getFileIconByExtension(filename) ?? FilesIcon)
+  // Note: "category" type will use the default file icon based on filename, which is fine since
+  // categories won't be inserted as mentions in the editor (they navigate to subpages)
 
   // Create a temporary container
   const container = document.createElement("div")
@@ -376,13 +399,40 @@ function SkillIconWrapper({ className }: { className?: string }) {
   return <SkillIcon className={className} />
 }
 
+function AgentIconWrapper({ className }: { className?: string }) {
+  return <AgentIcon className={className} />
+}
+
+// Category icon component
+function CategoryIcon({ className, categoryId }: { className?: string; categoryId: string }) {
+  if (categoryId === "files") {
+    return <FilesIcon className={className} />
+  }
+  if (categoryId === "skills") {
+    return <SkillIcon className={className} />
+  }
+  if (categoryId === "agents") {
+    return <AgentIcon className={className} />
+  }
+  return <FilesIcon className={className} />
+}
+
 /**
- * Get icon component for a file, folder, or skill option
+ * Get icon component for a file, folder, skill, agent, or category option
  */
-export function getOptionIcon(option: { label: string; type?: "file" | "folder" | "skill" }) {
+export function getOptionIcon(option: { id?: string; label: string; type?: "file" | "folder" | "skill" | "agent" | "category" }) {
+  if (option.type === "category") {
+    // Return a wrapper component for categories
+    return function CategoryIconWrapper({ className }: { className?: string }) {
+      return <CategoryIcon className={className} categoryId={option.id || ""} />
+    }
+  }
   if (option.type === "skill") {
     return SkillIconWrapper
   }
+  if (option.type === "agent") {
+    return AgentIconWrapper
+  }
   if (option.type === "folder") {
     return FolderIcon
   }
@@ -474,6 +524,49 @@ function sortFilesByRelevance<T extends { label: string; path?: string }>(
   })
 }
 
+/**
+ * Render tooltip content for a mention option
+ * Skills/agents show description, tools, model info
+ * Files/folders show path
+ */
+function renderTooltipContent(option: FileMentionOption) {
+  if (option.type === "folder") {
+    return renderFolderTree(option.path)
+  }
+
+  if (option.type === "skill" || option.type === "agent") {
+    return (
+      <div className="flex flex-col gap-1.5 w-full overflow-hidden">
+        {option.description && (
+          <p className="text-xs text-muted-foreground break-words">
+            {option.description}
+          </p>
+        )}
+        {option.model && (
+          <div className="text-xs text-muted-foreground">
+            Model: {option.model}
+          </div>
+        )}
+        {option.tools && option.tools.length > 0 && (
+          <div className="text-xs text-muted-foreground break-words">
+            Tools: {option.tools.join(", ")}
+          </div>
+        )}
+        <div className="text-[10px] text-muted-foreground/70 font-mono truncate w-full">
+          {option.path}
+        </div>
+      </div>
+    )
+  }
+
+  // Files - just path
+  return (
+    <div className="text-xs text-muted-foreground font-mono truncate w-full">
+      {option.path}
+    </div>
+  )
+}
+
 // Memoized to prevent re-renders when parent re-renders
 export const AgentsFileMention = memo(function AgentsFileMention({
   isOpen,
@@ -487,18 +580,15 @@ export const AgentsFileMention = memo(function AgentsFileMention({
   branch,
   projectPath,
   changedFiles = [],
+  showingFilesList = false,
+  showingSkillsList = false,
+  showingAgentsList = false,
 }: AgentsFileMentionProps) {
   const dropdownRef = useRef<HTMLDivElement>(null)
   const [selectedIndex, setSelectedIndex] = useState(0)
   const placementRef = useRef<"above" | "below" | null>(null)
   const [debouncedSearchText, setDebouncedSearchText] = useState(searchText)
 
-  // Tooltip state
-  const [tooltipVisible, setTooltipVisible] = useState(false)
-  const [tooltipPosition, setTooltipPosition] = useState({ top: 0, left: 0 })
-  const [tooltipContent, setTooltipContent] = useState("")
-  const [tooltipType, setTooltipType] = useState<"file" | "folder" | "skill">("file")
-  const [tooltipPlacement, setTooltipPlacement] = useState<"left" | "right">("left")
   const [hoverIndex, setHoverIndex] = useState<number | null>(null)
 
   // Fetch skills from filesystem (cached for 5 minutes)
@@ -507,6 +597,12 @@ export const AgentsFileMention = memo(function AgentsFileMention({
     staleTime: 5 * 60 * 1000, // 5 minutes - skills don't change frequently
   })
 
+  // Fetch custom agents from filesystem (cached for 5 minutes)
+  const { data: customAgents = [], isFetching: isFetchingAgents } = trpc.agents.listEnabled.useQuery(undefined, {
+    enabled: isOpen,
+    staleTime: 5 * 60 * 1000, // 5 minutes - agents don't change frequently
+  })
+
   // Debounce search text (300ms to match canvas implementation)
   useEffect(() => {
     const timer = setTimeout(() => {
@@ -604,51 +700,127 @@ export const AgentsFileMention = memo(function AgentsFileMention({
   // Convert skills to mention options
   const skillOptions: FileMentionOption[] = useMemo(() => {
     const searchLower = debouncedSearchText.toLowerCase()
-    
+
     return skills
-      .filter(skill => 
-        !searchLower || 
+      .filter(skill =>
+        !searchLower ||
         skill.name.toLowerCase().includes(searchLower) ||
         skill.description.toLowerCase().includes(searchLower)
       )
       .map(skill => ({
         id: `${MENTION_PREFIXES.SKILL}${skill.name}`,
         label: skill.name,
-        path: skill.description,
+        path: skill.path, // file path for tooltip
         repository: "",
         truncatedPath: skill.description,
         type: "skill" as const,
+        // Extended data for rich tooltip
+        description: skill.description,
+        source: skill.source,
       }))
   }, [skills, debouncedSearchText])
 
+  // Convert custom agents to mention options
+  const agentOptions: FileMentionOption[] = useMemo(() => {
+    const searchLower = debouncedSearchText.toLowerCase()
+
+    return customAgents
+      .filter(agent =>
+        !searchLower ||
+        agent.name.toLowerCase().includes(searchLower) ||
+        agent.description.toLowerCase().includes(searchLower)
+      )
+      .map(agent => ({
+        id: `${MENTION_PREFIXES.AGENT}${agent.name}`,
+        label: agent.name,
+        path: agent.path, // file path for tooltip
+        repository: "",
+        truncatedPath: agent.description,
+        type: "agent" as const,
+        // Extended data for rich tooltip
+        description: agent.description,
+        tools: agent.tools,
+        model: agent.model,
+        source: agent.source,
+      }))
+  }, [customAgents, debouncedSearchText])
+
+  // Check if we have skills or agents
+  const hasSkills = skillOptions.length > 0
+  const hasAgents = agentOptions.length > 0
+  const hasOnlyFiles = !hasSkills && !hasAgents
+
+  // Determine if we're in a subpage view (or showing files directly when no skills/agents)
+  const isInSubpage = showingFilesList || showingSkillsList || showingAgentsList || hasOnlyFiles
+
+  // Filter category options based on available data
+  const availableCategoryOptions = useMemo(() => {
+    return CATEGORY_OPTIONS.filter(category => {
+      if (category.id === "files") return true // Always show files
+      if (category.id === "skills") return hasSkills
+      if (category.id === "agents") return hasAgents
+      return true
+    })
+  }, [hasSkills, hasAgents])
+
   // Combined options for keyboard navigation
-  // When searching: merge all and sort globally (filename matches first)
-  // When not searching: keep groups separate (skills first, then changed files, then repo files)
+  // Subpage views show only that category's items
+  // Root view shows changed files + category navigation options
+  // Search filters globally in root view, within category in subpage
+  // If no skills or agents, skip root view and show files directly
   const options: FileMentionOption[] = useMemo(() => {
+    // SUBPAGE: Files (or if no skills/agents, show files directly)
+    if (showingFilesList || hasOnlyFiles) {
+      const allFiles = [...changedFileOptions, ...repoFileOptions]
+      if (debouncedSearchText) {
+        return sortFilesByRelevance(allFiles, debouncedSearchText)
+      }
+      return allFiles
+    }
+
+    // SUBPAGE: Skills
+    if (showingSkillsList) {
+      return skillOptions // already filtered by search in skillOptions memo
+    }
+
+    // SUBPAGE: Agents
+    if (showingAgentsList) {
+      return agentOptions // already filtered by search in agentOptions memo
+    }
+
+    // ROOT VIEW
     if (debouncedSearchText) {
-      // When searching: merge all files and skills, sort globally
-      const allItems = [...skillOptions, ...changedFileOptions, ...repoFileOptions]
+      // Global search: search across changed files + categories + skills + agents + repo files
+      const searchLower = debouncedSearchText.toLowerCase()
+      const filteredCategories = availableCategoryOptions.filter(c =>
+        c.label.toLowerCase().includes(searchLower)
+      )
+      const allItems = [...changedFileOptions, ...filteredCategories, ...skillOptions, ...agentOptions, ...repoFileOptions]
       return sortFilesByRelevance(allItems, debouncedSearchText)
     }
 
-    // No search: keep groups (skills first, then changed files, then repo files)
-    return [...skillOptions, ...changedFileOptions, ...repoFileOptions]
-  }, [skillOptions, changedFileOptions, repoFileOptions, debouncedSearchText])
-
-  // Flag to determine if we're in search mode (no groups)
-  const isSearchMode = debouncedSearchText.length > 0
+    // No search: Changed files FIRST (quick access), then category navigation
+    return [...changedFileOptions, ...availableCategoryOptions]
+  }, [showingFilesList, showingSkillsList, showingAgentsList, debouncedSearchText, changedFileOptions, repoFileOptions, skillOptions, agentOptions, hasOnlyFiles, availableCategoryOptions])
 
   // Track previous values for smarter selection reset
   const prevIsOpenRef = useRef(isOpen)
   const prevSearchRef = useRef(debouncedSearchText)
+  const prevShowingFilesListRef = useRef(showingFilesList)
+  const prevShowingSkillsListRef = useRef(showingSkillsList)
+  const prevShowingAgentsListRef = useRef(showingAgentsList)
 
   // CONSOLIDATED: Single useLayoutEffect for selection management (was 3 separate)
   useLayoutEffect(() => {
     const didJustOpen = isOpen && !prevIsOpenRef.current
     const didSearchChange = debouncedSearchText !== prevSearchRef.current
+    const didSubpageChange =
+      showingFilesList !== prevShowingFilesListRef.current ||
+      showingSkillsList !== prevShowingSkillsListRef.current ||
+      showingAgentsList !== prevShowingAgentsListRef.current
 
-    // Reset to 0 when opening or search changes
-    if (didJustOpen || didSearchChange) {
+    // Reset to 0 when opening, search changes, or subpage changes
+    if (didJustOpen || didSearchChange || didSubpageChange) {
       setSelectedIndex(0)
     }
     // Clamp to valid range if options shrunk
@@ -659,76 +831,18 @@ export const AgentsFileMention = memo(function AgentsFileMention({
     // Update refs
     prevIsOpenRef.current = isOpen
     prevSearchRef.current = debouncedSearchText
-  }, [isOpen, debouncedSearchText, options.length, selectedIndex])
+    prevShowingFilesListRef.current = showingFilesList
+    prevShowingSkillsListRef.current = showingSkillsList
+    prevShowingAgentsListRef.current = showingAgentsList
+  }, [isOpen, debouncedSearchText, options.length, selectedIndex, showingFilesList, showingSkillsList, showingAgentsList])
 
   // Reset placement when closed
   useEffect(() => {
     if (!isOpen) {
       placementRef.current = null
-      setTooltipVisible(false)
     }
   }, [isOpen])
 
-  // Update tooltip when selected/hovered item changes
-  // OPTIMIZED: Use requestAnimationFrame to batch DOM reads and prevent layout thrashing
-  useEffect(() => {
-    if (!isOpen) return
-
-    const activeIndex = hoverIndex ?? selectedIndex
-    const activeOption = options[activeIndex]
-
-    if (!activeOption?.path || !dropdownRef.current) {
-      setTooltipVisible(false)
-      return
-    }
-
-    // Use rAF to batch DOM reads and avoid layout thrashing
-    const rafId = requestAnimationFrame(() => {
-      if (!dropdownRef.current) return
-
-      const elements = dropdownRef.current.querySelectorAll(
-        "[data-option-index]",
-      )
-      const selectedElement = elements[activeIndex] as HTMLElement
-
-      if (selectedElement) {
-        const rect = selectedElement.getBoundingClientRect()
-        const dropdownRect = dropdownRef.current.getBoundingClientRect()
-
-        // Estimate tooltip width (rough calculation based on content)
-        // ~6px per character for monospace font at 10px + 16px padding
-        const estimatedTooltipWidth = Math.min(
-          activeOption.path.length * 6 + 16,
-          320, // max-w-xs = 320px
-        )
-
-        // Check if tooltip fits on the left
-        const spaceOnLeft = dropdownRect.left - 8 // 8px gap
-        const fitsOnLeft = spaceOnLeft >= estimatedTooltipWidth
-
-        if (fitsOnLeft) {
-          setTooltipPlacement("left")
-          setTooltipPosition({
-            top: rect.top,
-            left: dropdownRect.left - 4,
-          })
-        } else {
-          setTooltipPlacement("right")
-          setTooltipPosition({
-            top: rect.top,
-            left: dropdownRect.right + 4,
-          })
-        }
-
-        setTooltipContent(activeOption.path)
-        setTooltipType(activeOption.type || "file")
-        setTooltipVisible(true)
-      }
-    })
-
-    return () => cancelAnimationFrame(rafId)
-  }, [selectedIndex, hoverIndex, options, isOpen])
-
   // Keyboard navigation
   useEffect(() => {
     if (!isOpen) return
@@ -810,7 +924,13 @@ export const AgentsFileMention = memo(function AgentsFileMention({
   if (!isOpen) return null
 
   // Calculate dropdown dimensions (matching canvas style)
-  const dropdownWidth = 320
+  // Narrower dropdown when showing only categories (no changed files)
+  const hasChangedFiles = changedFileOptions.length > 0
+  const isRootView = !showingFilesList && !showingSkillsList && !showingAgentsList && !hasOnlyFiles
+  // Narrow dropdown for root view (categories only) and skills/agents subpages
+  // Wide dropdown for files (showingFilesList or hasOnlyFiles)
+  const useNarrowWidth = (isRootView && !hasChangedFiles && !debouncedSearchText) || showingSkillsList || showingAgentsList
+  const dropdownWidth = useNarrowWidth ? 200 : 320
   const itemHeight = 28
   const headerHeight = 24
   const requestedHeight = Math.min(
@@ -866,7 +986,7 @@ export const AgentsFileMention = memo(function AgentsFileMention({
   const transformY = placeAbove ? "translateY(-100%)" : "translateY(0)"
 
   return (
-    <>
+    <TooltipProvider delayDuration={300}>
       <div
         ref={dropdownRef}
         className="fixed z-[99999] overflow-hidden rounded-[10px] border border-border bg-popover py-1 text-xs text-popover-foreground shadow-lg dark"
@@ -906,21 +1026,30 @@ export const AgentsFileMention = memo(function AgentsFileMention({
         {/* File list */}
         {!isLoading && !error && options.length > 0 && (
           <>
-            {/* Search mode: flat list sorted by relevance */}
-            {isSearchMode ? (
-              <>
-                <div className="px-2.5 py-1.5 mx-1 text-xs font-medium text-muted-foreground flex items-center gap-1.5">
-                  <span>Files & Folders</span>
-                  {isFetching && !isLoading && (
-                    <IconSpinner className="h-2.5 w-2.5" />
-                  )}
-                </div>
+            {/* Flat list sorted by relevance */}
+            <>
+              {/* Header - only show in subpages or when searching, not in root view */}
+                {(isInSubpage || debouncedSearchText) && (
+                  <div className="px-2.5 py-1.5 mx-1 text-xs font-medium text-muted-foreground flex items-center gap-1.5">
+                    <span>
+                      {(showingFilesList || hasOnlyFiles) ? "Files & Folders" :
+                       showingSkillsList ? "Skills" :
+                       showingAgentsList ? "Agents" :
+                       "Results"}
+                    </span>
+                    {isFetching && !isLoading && (
+                      <IconSpinner className="h-2.5 w-2.5" />
+                    )}
+                  </div>
+                )}
                 {options.map((option, index) => {
                   const isSelected = selectedIndex === index
                   const OptionIcon = getOptionIcon(option)
-                  return (
+                  const isCategory = option.type === "category"
+                  const showTooltip = !isCategory && option.path
+
+                  const itemContent = (
                     <div
-                      key={option.id}
                       data-option-index={index}
                       onClick={() => onSelect(option)}
                       onMouseEnter={() => {
@@ -941,7 +1070,7 @@ export const AgentsFileMention = memo(function AgentsFileMention({
                     >
                       <OptionIcon className="h-3 w-3 text-muted-foreground flex-shrink-0" />
                       <span className="flex items-center gap-1 w-full min-w-0">
-                        <span className="shrink-0 whitespace-nowrap">
+                        <span className={cn("shrink-0 whitespace-nowrap", isCategory && "font-medium")}>
                           {option.label}
                         </span>
                         {/* Diff stats for changed files */}
@@ -959,7 +1088,8 @@ export const AgentsFileMention = memo(function AgentsFileMention({
                             ) : null}
                           </span>
                         )}
-                        {option.truncatedPath && (
+                        {/* Show truncated path for files only, not for skills/agents (they show in tooltip) */}
+                        {option.truncatedPath && !isCategory && option.type !== "skill" && option.type !== "agent" && (
                           <span
                             className="text-muted-foreground flex-1 min-w-0 ml-2 font-mono overflow-hidden text-[10px]"
                             style={{
@@ -974,227 +1104,40 @@ export const AgentsFileMention = memo(function AgentsFileMention({
                           </span>
                         )}
                       </span>
+                      {/* ChevronRight for category items (navigate to subpage) */}
+                      {isCategory && (
+                        <ChevronRight className="ml-auto h-3.5 w-3.5 text-muted-foreground flex-shrink-0" />
+                      )}
                     </div>
                   )
-                })}
-              </>
-            ) : (
-              /* Browse mode: show groups */
-              <>
-                {/* Skills group */}
-                {skillOptions.length > 0 && (
-                  <>
-                    <div className="px-2.5 py-1.5 mx-1 text-xs font-medium text-muted-foreground flex items-center gap-1.5">
-                      <span>Skills</span>
-                      {isFetchingSkills && <IconSpinner className="h-2.5 w-2.5" />}
-                    </div>
-                    {skillOptions.map((option, skillIndex) => {
-                      const index = skillIndex
-                      const isSelected = selectedIndex === index
-                      return (
-                        <div
-                          key={option.id}
-                          data-option-index={index}
-                          onClick={() => onSelect(option)}
-                          onMouseEnter={() => {
-                            setHoverIndex(index)
-                            setSelectedIndex(index)
-                          }}
-                          onMouseLeave={() => {
-                            setHoverIndex((prev) =>
-                              prev === index ? null : prev,
-                            )
-                          }}
-                          className={cn(
-                            "group inline-flex w-[calc(100%-8px)] mx-1 items-center whitespace-nowrap outline-none",
-                            "h-7 px-1.5 justify-start text-xs rounded-md",
-                            "transition-colors cursor-pointer select-none gap-1.5",
-                            isSelected
-                              ? "dark:bg-neutral-800 bg-accent text-foreground"
-                              : "text-muted-foreground dark:hover:bg-neutral-800 hover:bg-accent hover:text-foreground",
-                          )}
-                        >
-                          <SkillIcon className="h-3 w-3 flex-shrink-0" />
-                          <span className="flex items-center gap-1 w-full min-w-0">
-                            <span className="shrink-0 whitespace-nowrap font-medium">
-                              {option.label}
-                            </span>
-                            {option.truncatedPath && (
-                              <span
-                                className="text-muted-foreground flex-1 min-w-0 ml-2 overflow-hidden text-[10px] truncate"
-                              >
-                                {option.truncatedPath}
-                              </span>
-                            )}
-                          </span>
-                        </div>
-                      )
-                    })}
-                  </>
-                )}
 
-                {/* Changed files group */}
-                {changedFileOptions.length > 0 && (
-                  <>
-                    <div className="px-2.5 py-1.5 mx-1 text-xs font-medium text-muted-foreground">
-                      Changed in this chat
-                    </div>
-                    {changedFileOptions.map((option, changedIdx) => {
-                      const index = skillOptions.length + changedIdx
-                      const isSelected = selectedIndex === index
-                      const OptionIcon = getOptionIcon(option)
-                      return (
-                        <div
-                          key={option.id}
-                          data-option-index={index}
-                          onClick={() => onSelect(option)}
-                          onMouseEnter={() => {
-                            setHoverIndex(index)
-                            setSelectedIndex(index)
-                          }}
-                          onMouseLeave={() => {
-                            setHoverIndex((prev) =>
-                              prev === index ? null : prev,
-                            )
-                          }}
-                          className={cn(
-                            "group inline-flex w-[calc(100%-8px)] mx-1 items-center whitespace-nowrap outline-none",
-                            "h-7 px-1.5 justify-start text-xs rounded-md",
-                            "transition-colors cursor-pointer select-none gap-1.5",
-                            isSelected
-                              ? "dark:bg-neutral-800 bg-accent text-foreground"
-                              : "text-muted-foreground dark:hover:bg-neutral-800 hover:bg-accent hover:text-foreground",
-                          )}
+                  if (showTooltip) {
+                    return (
+                      <Tooltip key={option.id} open={isSelected}>
+                        <TooltipTrigger asChild>
+                          {itemContent}
+                        </TooltipTrigger>
+                        <TooltipContent
+                          side="left"
+                          align="start"
+                          sideOffset={8}
+                          collisionPadding={16}
+                          avoidCollisions
+                          className="overflow-hidden"
                         >
-                          <OptionIcon className="h-3 w-3 text-muted-foreground flex-shrink-0" />
-                          <span className="flex items-center gap-1 w-full min-w-0">
-                            <span className="shrink-0 whitespace-nowrap">
-                              {option.label}
-                            </span>
-                            {(option.additions || option.deletions) && (
-                              <span className="shrink-0 flex items-center gap-1 text-[10px] font-mono">
-                                {option.additions ? (
-                                  <span className="text-green-500">
-                                    +{option.additions}
-                                  </span>
-                                ) : null}
-                                {option.deletions ? (
-                                  <span className="text-red-500">
-                                    -{option.deletions}
-                                  </span>
-                                ) : null}
-                              </span>
-                            )}
-                            {option.truncatedPath && (
-                              <span
-                                className="text-muted-foreground flex-1 min-w-0 ml-2 font-mono overflow-hidden text-[10px]"
-                                style={{
-                                  direction: "rtl",
-                                  textAlign: "left",
-                                  whiteSpace: "nowrap",
-                                }}
-                              >
-                                <span style={{ direction: "ltr" }}>
-                                  {option.truncatedPath}
-                                </span>
-                              </span>
-                            )}
-                          </span>
-                        </div>
-                      )
-                    })}
-                  </>
-                )}
+                          {renderTooltipContent(option)}
+                        </TooltipContent>
+                      </Tooltip>
+                    )
+                  }
 
-                {/* Repo files group */}
-                {repoFileOptions.length > 0 && (
-                  <>
-                    <div className="px-2.5 py-1.5 mx-1 text-xs font-medium text-muted-foreground flex items-center gap-1.5">
-                      <span>Files & Folders</span>
-                      {isFetching && !isLoading && (
-                        <IconSpinner className="h-2.5 w-2.5" />
-                      )}
-                    </div>
-                    {repoFileOptions.map((option, repoIndex) => {
-                      const index = skillOptions.length + changedFileOptions.length + repoIndex
-                      const isSelected = selectedIndex === index
-                      const OptionIcon = getOptionIcon(option)
-                      return (
-                        <div
-                          key={option.id}
-                          data-option-index={index}
-                          onClick={() => onSelect(option)}
-                          onMouseEnter={() => {
-                            setHoverIndex(index)
-                            setSelectedIndex(index)
-                          }}
-                          onMouseLeave={() => {
-                            setHoverIndex((prev) =>
-                              prev === index ? null : prev,
-                            )
-                          }}
-                          className={cn(
-                            "group inline-flex w-[calc(100%-8px)] mx-1 items-center whitespace-nowrap outline-none",
-                            "h-7 px-1.5 justify-start text-xs rounded-md",
-                            "transition-colors cursor-pointer select-none gap-1.5",
-                            isSelected
-                              ? "dark:bg-neutral-800 bg-accent text-foreground"
-                              : "text-muted-foreground dark:hover:bg-neutral-800 hover:bg-accent hover:text-foreground",
-                          )}
-                        >
-                          <OptionIcon className="h-3 w-3 text-muted-foreground flex-shrink-0" />
-                          <span className="flex items-center gap-1 w-full min-w-0">
-                            <span className="shrink-0 whitespace-nowrap">
-                              {option.label}
-                            </span>
-                            {option.truncatedPath && (
-                              <span
-                                className="text-muted-foreground flex-1 min-w-0 ml-2 font-mono overflow-hidden text-[10px]"
-                                style={{
-                                  direction: "rtl",
-                                  textAlign: "left",
-                                  whiteSpace: "nowrap",
-                                }}
-                              >
-                                <span style={{ direction: "ltr" }}>
-                                  {option.truncatedPath}
-                                </span>
-                              </span>
-                            )}
-                          </span>
-                        </div>
-                      )
-                    })}
-                  </>
-                )}
+                  return <div key={option.id}>{itemContent}</div>
+                })}
               </>
-            )}
           </>
         )}
       </div>
-
-      {/* Tooltip for full path (tree view for folders) */}
-      {tooltipVisible && tooltipContent && (
-        <div
-          className={cn(
-            "fixed z-[100000] bg-popover border border-border rounded-lg shadow-lg dark",
-            tooltipType === "folder" ? "px-3 py-2" : "px-2 py-1 max-w-xs"
-          )}
-          style={{
-            top: tooltipPosition.top,
-            left: tooltipPosition.left,
-            transform: tooltipPlacement === "left" ? "translateX(-100%)" : "translateX(0)",
-          }}
-        >
-          {tooltipType === "folder" ? (
-            renderFolderTree(tooltipContent)
-          ) : (
-            <div className="text-foreground/90 font-mono text-[10px] truncate whitespace-nowrap">
-              {tooltipContent}
-            </div>
-          )}
-        </div>
-      )}
-    </>
+    </TooltipProvider>
   )
 })
+
diff --git a/src/renderer/features/agents/mentions/agents-mentions-editor.tsx b/src/renderer/features/agents/mentions/agents-mentions-editor.tsx
index ef10c8c..4f3a301 100644
--- a/src/renderer/features/agents/mentions/agents-mentions-editor.tsx
+++ b/src/renderer/features/agents/mentions/agents-mentions-editor.tsx
@@ -20,7 +20,12 @@ export interface FileMentionOption {
   truncatedPath?: string // directory path for inline display or skill description
   additions?: number // for changed files
   deletions?: number // for changed files
-  type?: "file" | "folder" | "skill" // entry type (default: file)
+  type?: "file" | "folder" | "skill" | "agent" | "category" // entry type (default: file)
+  // Extended data for rich tooltips (skills/agents)
+  description?: string // skill/agent description
+  tools?: string[] // agent allowed tools
+  model?: string // agent model
+  source?: "user" | "project" // skill/agent source
 }
 
 // Mention ID prefixes
@@ -28,6 +33,7 @@ export const MENTION_PREFIXES = {
   FILE: "file:",
   FOLDER: "folder:",
   SKILL: "skill:",
+  AGENT: "agent:",
 } as const
 
 type TriggerPayload = {
diff --git a/src/renderer/features/agents/mentions/render-file-mentions.tsx b/src/renderer/features/agents/mentions/render-file-mentions.tsx
index ce47988..264a2a2 100644
--- a/src/renderer/features/agents/mentions/render-file-mentions.tsx
+++ b/src/renderer/features/agents/mentions/render-file-mentions.tsx
@@ -2,7 +2,7 @@
 
 import { useMemo } from "react"
 import { getFileIconByExtension } from "./agents-file-mention"
-import { FilesIcon, SkillIcon } from "../../../components/ui/icons"
+import { FilesIcon, SkillIcon, AgentIcon } from "../../../components/ui/icons"
 import { MENTION_PREFIXES } from "./agents-mentions-editor"
 
 // Custom folder icon matching design
@@ -29,19 +29,20 @@ interface ParsedMention {
   label: string
   path: string
   repository: string
-  type: "file" | "folder" | "skill"
+  type: "file" | "folder" | "skill" | "agent"
 }
 
 /**
- * Parse file/folder/skill mention ID into its components
- * Format: file:owner/repo:path/to/file.tsx or folder:owner/repo:path/to/folder or skill:skill-name
+ * Parse file/folder/skill/agent mention ID into its components
+ * Format: file:owner/repo:path/to/file.tsx or folder:owner/repo:path/to/folder or skill:skill-name or agent:agent-name
  */
 function parseMention(id: string): ParsedMention | null {
   const isFile = id.startsWith(MENTION_PREFIXES.FILE)
   const isFolder = id.startsWith(MENTION_PREFIXES.FOLDER)
   const isSkill = id.startsWith(MENTION_PREFIXES.SKILL)
+  const isAgent = id.startsWith(MENTION_PREFIXES.AGENT)
 
-  if (!isFile && !isFolder && !isSkill) return null
+  if (!isFile && !isFolder && !isSkill && !isAgent) return null
 
   // Handle skill mentions (simpler format: skill:name)
   if (isSkill) {
@@ -55,6 +56,18 @@ function parseMention(id: string): ParsedMention | null {
     }
   }
 
+  // Handle agent mentions (simpler format: agent:name)
+  if (isAgent) {
+    const agentName = id.slice(MENTION_PREFIXES.AGENT.length)
+    return {
+      id,
+      label: agentName,
+      path: "",
+      repository: "",
+      type: "agent",
+    }
+  }
+
   const parts = id.split(":")
   if (parts.length < 3) return null
 
@@ -73,18 +86,22 @@ function parseMention(id: string): ParsedMention | null {
 }
 
 /**
- * Component to render a single file/folder/skill mention chip (matching canvas style)
+ * Component to render a single file/folder/skill/agent mention chip (matching canvas style)
  */
 function MentionChip({ mention }: { mention: ParsedMention }) {
   const Icon = mention.type === "skill"
     ? SkillIcon
-    : mention.type === "folder" 
-      ? FolderOpenIcon 
-      : (getFileIconByExtension(mention.label) ?? FilesIcon)
-  
-  const title = mention.type === "skill" 
+    : mention.type === "agent"
+      ? AgentIcon
+      : mention.type === "folder"
+        ? FolderOpenIcon
+        : (getFileIconByExtension(mention.label) ?? FilesIcon)
+
+  const title = mention.type === "skill"
     ? `Skill: ${mention.label}`
-    : `${mention.repository}:${mention.path}`
+    : mention.type === "agent"
+      ? `Agent: ${mention.label}`
+      : `${mention.repository}:${mention.path}`
   
   return (
     <span
@@ -198,8 +215,8 @@ export function extractFileMentions(text: string): ParsedMention[] {
 }
 
 /**
- * Check if text contains any file, folder, or skill mentions
+ * Check if text contains any file, folder, skill, or agent mentions
  */
 export function hasFileMentions(text: string): boolean {
-  return /@\[(file|folder|skill):[^\]]+\]/.test(text)
+  return /@\[(file|folder|skill|agent):[^\]]+\]/.test(text)
 }
diff --git a/src/renderer/features/agents/ui/agent-ask-user-question-tool.tsx b/src/renderer/features/agents/ui/agent-ask-user-question-tool.tsx
index 555dce5..c849693 100644
--- a/src/renderer/features/agents/ui/agent-ask-user-question-tool.tsx
+++ b/src/renderer/features/agents/ui/agent-ask-user-question-tool.tsx
@@ -1,9 +1,10 @@
 "use client"
 
 import { memo } from "react"
+import { useAtomValue } from "jotai"
 import { TextShimmer } from "../../../components/ui/text-shimmer"
 import { QuestionIcon } from "../../../components/ui/icons"
-import { QUESTIONS_SKIPPED_MESSAGE, QUESTIONS_TIMED_OUT_MESSAGE } from "../atoms"
+import { QUESTIONS_SKIPPED_MESSAGE, QUESTIONS_TIMED_OUT_MESSAGE, askUserQuestionResultsAtom, pendingUserQuestionsAtom } from "../atoms"
 
 interface AgentAskUserQuestionToolProps {
   input: {
@@ -23,6 +24,8 @@ interface AgentAskUserQuestionToolProps {
   errorText?: string
   state: "call" | "result"
   isError?: boolean
+  isStreaming?: boolean // Whether the message is currently streaming
+  toolCallId?: string // Tool call ID for looking up real-time results
 }
 
 export const AgentAskUserQuestionTool = memo(function AgentAskUserQuestionTool({
@@ -31,18 +34,31 @@ export const AgentAskUserQuestionTool = memo(function AgentAskUserQuestionTool({
   errorText,
   state,
   isError,
+  isStreaming,
+  toolCallId,
 }: AgentAskUserQuestionToolProps) {
   const questions = input?.questions ?? []
   const questionCount = questions.length
 
+  // Get real-time results from atom (for immediate updates before DB sync)
+  const resultsMap = useAtomValue(askUserQuestionResultsAtom)
+  const realtimeResult = toolCallId ? resultsMap.get(toolCallId) : undefined
+
+  // Check if the question dialog is currently shown for this tool
+  const pendingQuestions = useAtomValue(pendingUserQuestionsAtom)
+  const isDialogShown = pendingQuestions?.toolUseId === toolCallId
+
+  // Use realtime result if available, otherwise fall back to prop
+  const effectiveResult = realtimeResult ?? result
+
   // For errors, SDK stores errorText separately - use it to detect skip/timeout
   const effectiveErrorText =
-    errorText || (typeof result === "string" ? result : undefined)
+    errorText || (typeof effectiveResult === "string" ? effectiveResult : undefined)
 
   // Extract answers for display
   const answers =
-    result && typeof result === "object" && "answers" in result
-      ? result.answers
+    effectiveResult && typeof effectiveResult === "object" && "answers" in effectiveResult
+      ? (effectiveResult as { answers?: Record<string, string> }).answers
       : null
 
   // Determine status
@@ -51,12 +67,14 @@ export const AgentAskUserQuestionTool = memo(function AgentAskUserQuestionTool({
   const isCompleted =
     state === "result" && answers && !isSkipped && !isTimedOut && !isError
 
-  // Show loading state if no questions yet
-  if (questionCount === 0 && state === "call") {
+  // Show loading state if:
+  // 1. No questions yet (still streaming input)
+  // 2. Streaming but dialog not yet shown (waiting for ask-user-question chunk)
+  if (state === "call" && (questionCount === 0 || (isStreaming && !isDialogShown))) {
     return (
       <div className="flex items-center gap-2 py-1 px-2 text-xs text-muted-foreground">
         <TextShimmer className="text-xs" duration={1.5}>
-          Generating questions...
+          Asking question...
         </TextShimmer>
       </div>
     )
@@ -118,11 +136,39 @@ export const AgentAskUserQuestionTool = memo(function AgentAskUserQuestionTool({
 
   // Show pending state
   const firstQuestion = questions[0]?.header || questions[0]?.question
+
+  // If streaming THIS message, show "Waiting for response..."
+  // isStreaming is true only when global streaming is active AND this is the last message
+  if (isStreaming) {
+    return (
+      <div className="flex items-center gap-2 py-1 px-2 text-xs text-muted-foreground">
+        <span>{firstQuestion || "Question"}</span>
+        <span className="text-muted-foreground/50"></span>
+        <span>Waiting for response...</span>
+      </div>
+    )
+  }
+
+  // If we have a realtime result but it hasn't synced to the message yet,
+  // show "Submitting..." (user just answered, waiting for sync)
+  // Note: realtimeResult is set immediately when user answers via ask-user-question-result chunk
+  // If there's no realtimeResult and no answers, the stream was interrupted without an answer
+  if (state === "result" && realtimeResult && !answers && !isError && !isSkipped && !isTimedOut) {
+    return (
+      <div className="flex items-center gap-2 py-1 px-2 text-xs text-muted-foreground">
+        <span>{firstQuestion || "Question"}</span>
+        <span className="text-muted-foreground/50"></span>
+        <span>Submitting...</span>
+      </div>
+    )
+  }
+
+  // Not streaming and state is "call" - it was truly interrupted
   return (
     <div className="flex items-center gap-2 py-1 px-2 text-xs text-muted-foreground">
       <span>{firstQuestion || "Question"}</span>
       <span className="text-muted-foreground/50"></span>
-      <span>Waiting for response...</span>
+      <span>Interrupted</span>
     </div>
   )
 })
diff --git a/src/renderer/features/agents/ui/agent-user-question.tsx b/src/renderer/features/agents/ui/agent-user-question.tsx
index 5a3341e..6a52c50 100644
--- a/src/renderer/features/agents/ui/agent-user-question.tsx
+++ b/src/renderer/features/agents/ui/agent-user-question.tsx
@@ -147,6 +147,7 @@ export const AgentUserQuestion = memo(function AgentUserQuestion({
     questions,
     currentQuestion?.question,
     isSubmitting,
+    pendingQuestions.toolUseId,
   ])
 
   const handleSkipWithGuard = useCallback(() => {
diff --git a/src/renderer/features/agents/ui/sub-chat-context-menu.tsx b/src/renderer/features/agents/ui/sub-chat-context-menu.tsx
index 00a0c6b..657b408 100644
--- a/src/renderer/features/agents/ui/sub-chat-context-menu.tsx
+++ b/src/renderer/features/agents/ui/sub-chat-context-menu.tsx
@@ -63,10 +63,10 @@ export function SubChatContextMenu({
   return (
     <ContextMenuContent className="w-48">
       <ContextMenuItem onClick={() => onTogglePin(subChat.id)}>
-        {isPinned ? "Unpin agent" : "Pin agent"}
+        {isPinned ? "Unpin chat" : "Pin chat"}
       </ContextMenuItem>
       <ContextMenuItem onClick={() => onRename(subChat)}>
-        Rename agent
+        Rename chat
       </ContextMenuItem>
       <ContextMenuSeparator />
 
@@ -77,20 +77,20 @@ export function SubChatContextMenu({
             className="justify-between"
             disabled={isOnlyChat}
           >
-            Close tab
+            Close chat
             {!isOnlyChat && <Kbd>{closeTabShortcut}</Kbd>}
           </ContextMenuItem>
           <ContextMenuItem
             onClick={() => onCloseOtherTabs?.(subChat.id)}
             disabled={!canCloseOtherTabs}
           >
-            Close other tabs
+            Close other chats
           </ContextMenuItem>
           <ContextMenuItem
             onClick={() => onCloseTabsToRight?.(subChat.id, visualIndex)}
             disabled={!hasTabsToRight}
           >
-            Close tabs to the right
+            Close chats to the right
           </ContextMenuItem>
         </>
       ) : (
@@ -100,7 +100,7 @@ export function SubChatContextMenu({
             className="justify-between"
             disabled={isOnlyChat}
           >
-            Archive agent
+            Archive chat
             {!isOnlyChat && <Kbd>{closeTabShortcut}</Kbd>}
           </ContextMenuItem>
           <ContextMenuItem
@@ -110,13 +110,13 @@ export function SubChatContextMenu({
               currentIndex >= (totalCount || 0) - 1
             }
           >
-            Archive agents below
+            Archive chats below
           </ContextMenuItem>
           <ContextMenuItem
             onClick={() => onArchiveOthers(subChat.id)}
             disabled={isOnlyChat}
           >
-            Archive other agents
+            Archive other chats
           </ContextMenuItem>
         </>
       )}
diff --git a/src/renderer/features/agents/ui/sub-chat-selector.tsx b/src/renderer/features/agents/ui/sub-chat-selector.tsx
index db3b313..4879092 100644
--- a/src/renderer/features/agents/ui/sub-chat-selector.tsx
+++ b/src/renderer/features/agents/ui/sub-chat-selector.tsx
@@ -6,6 +6,7 @@ import {
   loadingSubChatsAtom,
   agentsSubChatUnseenChangesAtom,
   agentsSubChatsSidebarModeAtom,
+  pendingUserQuestionsAtom,
 } from "../atoms"
 import { X, Plus, AlignJustify, Play } from "lucide-react"
 import {
@@ -16,6 +17,7 @@ import {
   PinFilledIcon,
   DiffIcon,
   ClockIcon,
+  QuestionIcon,
 } from "../../../components/ui/icons"
 import { Button } from "../../../components/ui/button"
 import { cn } from "../../../lib/utils"
@@ -89,6 +91,7 @@ export function SubChatSelector({
   const [subChatsSidebarMode, setSubChatsSidebarMode] = useAtom(
     agentsSubChatsSidebarModeAtom,
   )
+  const pendingQuestions = useAtomValue(pendingUserQuestionsAtom)
 
   const [isHistoryOpen, setIsHistoryOpen] = useState(false)
   const tabsContainerRef = useRef<HTMLDivElement>(null)
@@ -487,6 +490,8 @@ export function SubChatSelector({
                 const isPinned = pinnedSubChatIds.includes(subChat.id)
                 // Get mode from sub-chat itself (defaults to "agent")
                 const mode = subChat.mode || "agent"
+                // Check if this chat is waiting for user answer
+                const hasPendingQuestion = pendingQuestions?.subChatId === subChat.id
 
                 return (
                   <ContextMenu key={subChat.id}>
@@ -524,11 +529,14 @@ export function SubChatSelector({
                             : "hover:bg-muted/80 max-w-[150px]",
                         )}
                       >
-                        {/* Icon: loading spinner OR mode icon with badge (hide when editing) */}
+                        {/* Icon: question icon (priority) OR loading spinner OR mode icon with badge (hide when editing) */}
                         {editingSubChatId !== subChat.id && (
                           <div className="flex-shrink-0 w-3.5 h-3.5 flex items-center justify-center relative">
-                            {isLoading ? (
-                              // Loading: show only spinner (replaces entire icon block)
+                            {hasPendingQuestion ? (
+                              // Waiting for user answer: show question icon (highest priority)
+                              <QuestionIcon className="w-3.5 h-3.5 text-blue-500" />
+                            ) : isLoading ? (
+                              // Loading: show spinner
                               <IconSpinner className="w-3.5 h-3.5 text-muted-foreground" />
                             ) : (
                               <>
@@ -702,19 +710,22 @@ export function SubChatSelector({
               const isLoading = loadingSubChats.has(subChat.id)
               const hasUnseen = subChatUnseenChanges.has(subChat.id)
               const mode = subChat.mode || "agent"
+              const hasPendingQuestion = pendingQuestions?.subChatId === subChat.id
 
               return (
                 <div className="flex items-center gap-2 flex-1 min-w-0">
-                  {/* Icon with badge */}
+                  {/* Icon with badge - question icon has priority */}
                   <div className="flex-shrink-0 w-4 h-4 flex items-center justify-center relative">
-                    {isLoading ? (
+                    {hasPendingQuestion ? (
+                      <QuestionIcon className="w-4 h-4 text-blue-500" />
+                    ) : isLoading ? (
                       <IconSpinner className="w-4 h-4 text-muted-foreground" />
                     ) : mode === "plan" ? (
                       <PlanIcon className="w-4 h-4 text-muted-foreground" />
                     ) : (
                       <AgentIcon className="w-4 h-4 text-muted-foreground" />
                     )}
-                    {hasUnseen && !isLoading && (
+                    {hasUnseen && !isLoading && !hasPendingQuestion && (
                       <div className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full bg-popover flex items-center justify-center">
                         <div className="w-1.5 h-1.5 rounded-full bg-[#307BD0]" />
                       </div>
diff --git a/src/renderer/features/sidebar/agents-subchats-sidebar.tsx b/src/renderer/features/sidebar/agents-subchats-sidebar.tsx
index b7a5e19..f1a70e6 100644
--- a/src/renderer/features/sidebar/agents-subchats-sidebar.tsx
+++ b/src/renderer/features/sidebar/agents-subchats-sidebar.tsx
@@ -13,6 +13,7 @@ import {
   selectedAgentChatIdAtom,
   subChatFilesAtom,
   justCreatedIdsAtom,
+  pendingUserQuestionsAtom,
 } from "../agents/atoms"
 import {
   selectedTeamIdAtom,
@@ -39,6 +40,7 @@ import {
   AgentIcon,
   IconOpenSidebar,
   ClockIcon,
+  QuestionIcon,
 } from "../../components/ui/icons"
 import {
   Tooltip,
@@ -120,6 +122,7 @@ export function AgentsSubChatsSidebar({
   const subChatUnseenChanges = useAtomValue(agentsSubChatUnseenChangesAtom)
   const setSubChatUnseenChanges = useSetAtom(agentsSubChatUnseenChangesAtom)
   const [justCreatedIds, setJustCreatedIds] = useAtom(justCreatedIdsAtom)
+  const pendingQuestions = useAtomValue(pendingUserQuestionsAtom)
   const [searchQuery, setSearchQuery] = useState("")
   const [isHistoryOpen, setIsHistoryOpen] = useState(false)
   const [focusedChatIndex, setFocusedChatIndex] = useState<number>(-1)
@@ -768,19 +771,22 @@ export function AgentsSubChatsSidebar({
           const isLoading = loadingSubChats.has(subChat.id)
           const hasUnseen = subChatUnseenChanges.has(subChat.id)
           const mode = subChat.mode || "agent"
+          const hasPendingQuestion = pendingQuestions?.subChatId === subChat.id
 
           return (
             <div className="flex items-center gap-2 flex-1 min-w-0">
-              {/* Icon with badge */}
+              {/* Icon with badge - question icon has priority */}
               <div className="flex-shrink-0 w-4 h-4 flex items-center justify-center relative">
-                {isLoading ? (
+                {hasPendingQuestion ? (
+                  <QuestionIcon className="w-4 h-4 text-blue-500" />
+                ) : isLoading ? (
                   <IconSpinner className="w-4 h-4 text-muted-foreground" />
                 ) : mode === "plan" ? (
                   <PlanIcon className="w-4 h-4 text-muted-foreground" />
                 ) : (
                   <AgentIcon className="w-4 h-4 text-muted-foreground" />
                 )}
-                {hasUnseen && !isLoading && (
+                {hasUnseen && !isLoading && !hasPendingQuestion && (
                   <div className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full bg-popover flex items-center justify-center">
                     <div className="w-1.5 h-1.5 rounded-full bg-[#307BD0]" />
                   </div>
@@ -1045,6 +1051,7 @@ export function AgentsSubChatsSidebar({
                           const mode = subChat.mode || "agent"
                           const isChecked = selectedSubChatIds.has(subChat.id)
                           const draftText = getDraftText(subChat.id)
+                          const hasPendingQuestion = pendingQuestions?.subChatId === subChat.id
                           const fileChanges = subChatFiles.get(subChat.id) || []
                           const stats =
                             fileChanges.length > 0
@@ -1128,7 +1135,7 @@ export function AgentsSubChatsSidebar({
                                           tabIndex={isMultiSelectMode ? 0 : -1}
                                         />
                                       </div>
-                                      {/* Mode icon - hidden in multi-select mode */}
+                                      {/* Mode icon or Question icon - hidden in multi-select mode */}
                                       <div
                                         className={cn(
                                           "transition-[opacity,transform] duration-150 ease-out",
@@ -1137,15 +1144,17 @@ export function AgentsSubChatsSidebar({
                                             : "opacity-100 scale-100",
                                         )}
                                       >
-                                        {mode === "plan" ? (
+                                        {hasPendingQuestion ? (
+                                          <QuestionIcon className="w-4 h-4 text-blue-500" />
+                                        ) : mode === "plan" ? (
                                           <PlanIcon className="w-4 h-4 text-muted-foreground" />
                                         ) : (
                                           <AgentIcon className="w-4 h-4 text-muted-foreground" />
                                         )}
                                       </div>
-                                      {/* Badge in bottom-right corner - hidden in multi-select mode */}
+                                      {/* Badge in bottom-right corner - hidden in multi-select mode and when pending question */}
                                       {(isSubChatLoading || hasUnseen) &&
-                                        !isMultiSelectMode && (
+                                        !isMultiSelectMode && !hasPendingQuestion && (
                                           <div
                                             className={cn(
                                               "absolute -bottom-1 -right-1 w-3 h-3 rounded-full flex items-center justify-center",
@@ -1315,6 +1324,7 @@ export function AgentsSubChatsSidebar({
                           const mode = subChat.mode || "agent"
                           const isChecked = selectedSubChatIds.has(subChat.id)
                           const draftText = getDraftText(subChat.id)
+                          const hasPendingQuestion = pendingQuestions?.subChatId === subChat.id
                           const fileChanges = subChatFiles.get(subChat.id) || []
                           const stats =
                             fileChanges.length > 0
@@ -1398,7 +1408,7 @@ export function AgentsSubChatsSidebar({
                                           tabIndex={isMultiSelectMode ? 0 : -1}
                                         />
                                       </div>
-                                      {/* Mode icon - hidden in multi-select mode */}
+                                      {/* Mode icon or Question icon - hidden in multi-select mode */}
                                       <div
                                         className={cn(
                                           "transition-[opacity,transform] duration-150 ease-out",
@@ -1407,15 +1417,17 @@ export function AgentsSubChatsSidebar({
                                             : "opacity-100 scale-100",
                                         )}
                                       >
-                                        {mode === "plan" ? (
+                                        {hasPendingQuestion ? (
+                                          <QuestionIcon className="w-4 h-4 text-blue-500" />
+                                        ) : mode === "plan" ? (
                                           <PlanIcon className="w-4 h-4 text-muted-foreground" />
                                         ) : (
                                           <AgentIcon className="w-4 h-4 text-muted-foreground" />
                                         )}
                                       </div>
-                                      {/* Badge - hidden in multi-select mode */}
+                                      {/* Badge - hidden in multi-select mode and when pending question */}
                                       {(isSubChatLoading || hasUnseen) &&
-                                        !isMultiSelectMode && (
+                                        !isMultiSelectMode && !hasPendingQuestion && (
                                           <div
                                             className={cn(
                                               "absolute -bottom-1 -right-1 w-3 h-3 rounded-full flex items-center justify-center",
diff --git a/src/renderer/features/sub-chats/sub-chat-context-menu.tsx b/src/renderer/features/sub-chats/sub-chat-context-menu.tsx
index c0ab44c..8188e48 100644
--- a/src/renderer/features/sub-chats/sub-chat-context-menu.tsx
+++ b/src/renderer/features/sub-chats/sub-chat-context-menu.tsx
@@ -63,10 +63,10 @@ export function SubChatContextMenu({
   return (
     <ContextMenuContent className="w-48">
       <ContextMenuItem onClick={() => onTogglePin(subChat.id)}>
-        {isPinned ? "Unpin agent" : "Pin agent"}
+        {isPinned ? "Unpin chat" : "Pin chat"}
       </ContextMenuItem>
       <ContextMenuItem onClick={() => onRename(subChat)}>
-        Rename agent
+        Rename chat
       </ContextMenuItem>
       <ContextMenuSeparator />
 
@@ -77,20 +77,20 @@ export function SubChatContextMenu({
             className="justify-between"
             disabled={isOnlyChat}
           >
-            Close tab
+            Close chat
             {!isOnlyChat && <Kbd>{closeTabShortcut}</Kbd>}
           </ContextMenuItem>
           <ContextMenuItem
             onClick={() => onCloseOtherTabs?.(subChat.id)}
             disabled={!canCloseOtherTabs}
           >
-            Close other tabs
+            Close other chats
           </ContextMenuItem>
           <ContextMenuItem
             onClick={() => onCloseTabsToRight?.(subChat.id, visualIndex)}
             disabled={!hasTabsToRight}
           >
-            Close tabs to the right
+            Close chats to the right
           </ContextMenuItem>
         </>
       ) : (
@@ -100,7 +100,7 @@ export function SubChatContextMenu({
             className="justify-between"
             disabled={isOnlyChat}
           >
-            Archive agent
+            Archive chat
             {!isOnlyChat && <Kbd>{closeTabShortcut}</Kbd>}
           </ContextMenuItem>
           <ContextMenuItem
@@ -110,13 +110,13 @@ export function SubChatContextMenu({
               currentIndex >= (totalCount || 0) - 1
             }
           >
-            Archive agents below
+            Archive chats below
           </ContextMenuItem>
           <ContextMenuItem
             onClick={() => onArchiveOthers(subChat.id)}
             disabled={isOnlyChat}
           >
-            Archive other agents
+            Archive other chats
           </ContextMenuItem>
         </>
       )}
diff --git a/src/renderer/features/sub-chats/sub-chats-sidebar.tsx b/src/renderer/features/sub-chats/sub-chats-sidebar.tsx
index 44e50e5..a4221a8 100644
--- a/src/renderer/features/sub-chats/sub-chats-sidebar.tsx
+++ b/src/renderer/features/sub-chats/sub-chats-sidebar.tsx
@@ -14,6 +14,7 @@ import {
   selectAllSubChatsAtom,
   clearSubChatSelectionAtom,
   selectedSubChatsCountAtom,
+  pendingUserQuestionsAtom,
 } from "../../lib/atoms"
 import {
   useAgentSubChatStore,
@@ -26,6 +27,7 @@ import {
   PlanIcon,
   AgentIcon,
   ClockIcon,
+  QuestionIcon,
 } from "../../components/ui/icons"
 import {
   Tooltip,
@@ -81,6 +83,8 @@ export function SubChatsSidebar({
 
   const subChatUnseenChanges = useAtomValue(agentsSubChatUnseenChangesAtom)
   const setSubChatUnseenChanges = useSetAtom(agentsSubChatUnseenChangesAtom)
+  const pendingQuestions = useAtomValue(pendingUserQuestionsAtom)
+
   const [searchQuery, setSearchQuery] = useState("")
   const [isHistoryOpen, setIsHistoryOpen] = useState(false)
   const [focusedChatIndex, setFocusedChatIndex] = useState<number>(-1)
@@ -593,6 +597,7 @@ export function SubChatsSidebar({
     const mode = subChat.mode || "agent"
     const isChecked = selectedSubChatIds.has(subChat.id)
     const draftText = getDraftText(subChat.id)
+    const hasPendingQuestion = pendingQuestions?.subChatId === subChat.id
 
     return (
       <ContextMenu key={subChat.id}>
@@ -636,7 +641,7 @@ export function SubChatsSidebar({
             <div className="flex items-start gap-2.5">
               {/* Icon/Checkbox container */}
               <div className="pt-0.5 flex-shrink-0 w-4 h-4 flex items-center justify-center relative">
-                {/* Mode icon */}
+                {/* Mode icon or Question icon */}
                 <div
                   className={cn(
                     "transition-[opacity,transform] duration-150 ease-out",
@@ -645,14 +650,16 @@ export function SubChatsSidebar({
                       : "opacity-100 scale-100",
                   )}
                 >
-                  {mode === "plan" ? (
+                  {hasPendingQuestion ? (
+                    <QuestionIcon className="w-4 h-4 text-blue-500" />
+                  ) : mode === "plan" ? (
                     <PlanIcon className="w-4 h-4 text-muted-foreground" />
                   ) : (
                     <AgentIcon className="w-4 h-4 text-muted-foreground" />
                   )}
                 </div>
-                {/* Badge */}
-                {(isSubChatLoading || hasUnseen) && !isMultiSelectMode && (
+                {/* Badge - don't show when pending question (icon already indicates status) */}
+                {(isSubChatLoading || hasUnseen) && !isMultiSelectMode && !hasPendingQuestion && (
                   <div
                     className={cn(
                       "absolute -bottom-1 -right-1 w-3 h-3 rounded-full flex items-center justify-center",
diff --git a/src/renderer/lib/atoms/index.ts b/src/renderer/lib/atoms/index.ts
index cb4520d..20d7c3a 100644
--- a/src/renderer/lib/atoms/index.ts
+++ b/src/renderer/lib/atoms/index.ts
@@ -56,6 +56,9 @@ export {
   // Todos
   currentTodosAtomFamily,
 
+  // AskUserQuestion
+  pendingUserQuestionsAtom,
+
   // Types
   type SavedRepo,
   type SelectedProject,
@@ -160,7 +163,7 @@ export const clearSubChatSelectionAtom = atom(null, (_get, set) => {
 // ============================================
 
 // Settings dialog
-export type SettingsTab = "profile" | "appearance" | "preferences" | "debug"
+export type SettingsTab = "profile" | "appearance" | "preferences" | "skills" | "agents" | "debug"
 export const agentsSettingsDialogActiveTabAtom = atom<SettingsTab>("profile")
 export const agentsSettingsDialogOpenAtom = atom<boolean>(false)
 
